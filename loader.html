<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XiaoZhi - Loading...</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .loader {
            text-align: center;
            padding: 20px;
        }
        .spinner {
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        h2 { margin: 10px 0; font-size: 24px; }
        p { margin: 5px 0; opacity: 0.9; font-size: 14px; }
        .error {
            display: none;
            color: #ff6b6b;
            margin-top: 20px;
            padding: 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
        }
        button {
            margin-top: 10px;
            padding: 10px 20px;
            background: white;
            color: #667eea;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
        }
        button:hover { background: #f0f0f0; }
    </style>
</head>
<body>
    <div class="loader">
        <div class="spinner"></div>
        <h2>Đang tải...</h2>
        <p>Loading XiaoZhi Settings...</p>
        <div class="error" id="error">
            <p>⚠️ Không thể tải từ hosting</p>
            <p style="font-size: 12px; margin-top: 5px;">Đang thử tải từ ESP32...</p>
            <button onclick="retryLoad()">Thử lại</button>
        </div>
    </div>
    
    <script>
        const ESP32_IP = window.location.hostname;
        const ESP32_PORT = window.location.port || '80';
        const ESP32_BASE = `http://${ESP32_IP}:${ESP32_PORT}`;
        
        // Xác định trang cần load dựa trên pathname
        const path = window.location.pathname;
        let htmlUrl, fallbackUrl, pageName;
        
        if (path.includes('/otto') || path.includes('/control')) {
            htmlUrl = 'https://nguenvanky.github.io/App/pages/otto.html';
            fallbackUrl = `${ESP32_BASE}/otto-fallback`;
            pageName = 'Otto Control';
        } else if (path.includes('/servo') || path.includes('/servo-calibration')) {
            htmlUrl = 'https://nguenvanky.github.io/App/pages/servo.html';
            fallbackUrl = `${ESP32_BASE}/servo-fallback`;
            pageName = 'Servo Calibration';
        } else {
            htmlUrl = 'https://nguenvanky.github.io/App/pages/settings.html';
            fallbackUrl = `${ESP32_BASE}/settings-fallback`;
            pageName = 'Settings';
        }
        
        // Update loading message
        document.querySelector('p').textContent = `Loading ${pageName}...`;
        
        // Configuration
        const MAX_RETRIES = 3;
        const TIMEOUT_MS = 15000; // 15 seconds timeout
        const RETRY_DELAY_MS = 1000; // 1 second between retries
        
        let retryCount = 0;
        
        // Fetch with timeout
        function fetchWithTimeout(url, options, timeout) {
            return Promise.race([
                fetch(url, options),
                new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('Timeout')), timeout)
                )
            ]);
        }
        
        // Thử load từ hosting (với retry và timeout)
        function loadFromHosting(retryAttempt = 0) {
            // Update loading message with retry info
            if (retryAttempt > 0) {
                document.querySelector('p').textContent = 
                    `Loading ${pageName}... (Retry ${retryAttempt}/${MAX_RETRIES})`;
            }
            
            // Try with cache first, then without cache
            const cacheMode = retryAttempt === 0 ? 'default' : 'no-cache';
            
            fetchWithTimeout(htmlUrl, {
                cache: cacheMode,
                headers: {
                    'Cache-Control': retryAttempt === 0 ? 'max-age=3600' : 'no-cache'
                }
            }, TIMEOUT_MS)
            .then(response => {
                if (!response.ok) {
                    // 404 or other HTTP errors - should fallback
                    if (response.status === 404) {
                        throw new Error('Not Found');
                    }
                    // Other HTTP errors - retry
                    throw new Error(`HTTP ${response.status}`);
                }
                return response.text();
            })
            .then(html => {
                // Success - replace document
                document.open();
                document.write(html);
                document.close();
            })
            .catch(error => {
                console.error(`Failed to load from hosting (attempt ${retryAttempt + 1}):`, error);
                
                // Retry if we haven't exceeded max retries
                if (retryAttempt < MAX_RETRIES - 1) {
                    // Wait before retry
                    setTimeout(() => {
                        loadFromHosting(retryAttempt + 1);
                    }, RETRY_DELAY_MS);
                } else {
                    // All retries failed - fallback to ESP32
                    console.warn('All retries failed, falling back to ESP32');
                    loadFromESP32();
                }
            });
        }
        
        // Fallback: Load từ ESP32
        function loadFromESP32() {
            document.getElementById('error').style.display = 'block';
            fetch(fallbackUrl)
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    return response.text();
                })
                .then(html => {
                    document.open();
                    document.write(html);
                    document.close();
                })
                .catch(err => {
                    document.getElementById('error').innerHTML = 
                        '<p>❌ Lỗi: Không thể tải trang</p>' +
                        '<p style="font-size: 12px;">Vui lòng kiểm tra kết nối internet hoặc ESP32.</p>';
                });
        }
        
        function retryLoad() {
            document.getElementById('error').style.display = 'none';
            retryCount = 0;
            loadFromHosting(0);
        }
        
        // Bắt đầu load sau 100ms (để UI render trước)
        setTimeout(() => loadFromHosting(0), 100);
    </script>
</body>
</html>