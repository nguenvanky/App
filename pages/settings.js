// Auto-generated JavaScript for Settings page
// This file injects HTML content into the DOM when loaded

(function() {
    'use strict';
    
    // HTML content as string
    const HTML_CONTENT = "\\n<!DOCTYPE html>\\n<html>\\n<head>\\n    <meta charset=\"UTF-8\">\\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\\n    <title>Xiaozhi Settings</title>\\n    <!-- Load CSS from external -->\\n    <link rel=\"stylesheet\" href=\"https://nguenvanky.github.io/App/styles/settings.min.css?v=1.0.0\" \\n          onerror=\"loadFallbackCSS(\'settings\')\">\\n    <!-- Fallback CSS (minimal inline for offline mode) -->\\n    <noscript>\\n        <style>\\n            * { box-sizing: border-box; }\\n            body { \\n                font-family: \'Segoe UI\', Tahoma, Geneva, Verdana, sans-serif; \\n                margin: 0; \\n                padding: 20px; \\n                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\\n                min-height: 100vh;\\n                position: relative;\\n            }\\n        .contact-info {\\n            position: fixed;\\n            top: 20px;\\n            right: 20px;\\n            background: rgba(255, 255, 255, 0.95);\\n            padding: 15px 20px;\\n            border-radius: 12px;\\n            box-shadow: 0 4px 15px rgba(0,0,0,0.2);\\n            z-index: 1000;\\n            backdrop-filter: blur(10px);\\n            animation: slideInRight 0.5s ease-out;\\n        }\\n        .pwa-install-fixed {\\n            position: fixed;\\n            bottom: 20px;\\n            right: 20px;\\n            background: rgba(255, 255, 255, 0.95);\\n            padding: 15px 20px;\\n            border-radius: 12px;\\n            box-shadow: 0 4px 15px rgba(0,0,0,0.2);\\n            z-index: 1000;\\n            backdrop-filter: blur(10px);\\n            animation: slideInRight 0.5s ease-out;\\n            text-align: center;\\n        }\\n        .contact-info a {\\n            color: #667eea;\\n            text-decoration: none;\\n            font-weight: bold;\\n            display: block;\\n            margin-bottom: 8px;\\n            transition: color 0.3s;\\n        }\\n        .contact-info a:hover {\\n            color: #764ba2;\\n        }\\n        .contact-info .phone {\\n            color: #333;\\n            font-size: 14px;\\n        }\\n        .lang-selector {\\n            position: fixed;\\n            top: 20px;\\n            left: 20px;\\n            background: rgba(255, 255, 255, 0.95);\\n            padding: 10px 15px;\\n            border-radius: 12px;\\n            box-shadow: 0 4px 15px rgba(0,0,0,0.2);\\n            z-index: 1000;\\n            backdrop-filter: blur(10px);\\n        }\\n        .lang-selector select {\\n            padding: 8px 12px;\\n            border: 2px solid #667eea;\\n            border-radius: 8px;\\n            font-size: 14px;\\n            background: white;\\n            color: #333;\\n            cursor: pointer;\\n            outline: none;\\n            font-weight: 600;\\n        }\\n        .lang-selector select:focus {\\n            border-color: #764ba2;\\n            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);\\n        }\\n        .lang-selector label {\\n            display: inline-block;\\n            margin-right: 8px;\\n            font-weight: 600;\\n            color: #667eea;\\n            font-size: 14px;\\n        }\\n        @keyframes slideInRight {\\n            from { transform: translateX(100px); opacity: 0; }\\n            to { transform: translateX(0); opacity: 1; }\\n        }\\n        .container { \\n            max-width: 700px; \\n            margin: 0 auto; \\n            background: white; \\n            padding: 30px; \\n            border-radius: 16px; \\n            box-shadow: 0 10px 40px rgba(0,0,0,0.2);\\n            position: relative;\\n            animation: fadeInUp 0.6s ease-out;\\n        }\\n        @keyframes fadeInUp {\\n            from { transform: translateY(30px); opacity: 0; }\\n            to { transform: translateY(0); opacity: 1; }\\n        }\\n        @keyframes slideIn {\\n            from { transform: translateY(10px); opacity: 0; }\\n            to { transform: translateY(0); opacity: 1; }\\n        }\\n        @keyframes typing {\\n            0%, 100% { opacity: 1; }\\n            50% { opacity: 0.5; }\\n        }\\n        h1 { \\n            color: #667eea; \\n            margin-top: 0; \\n            font-size: 28px;\\n            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\\n            -webkit-background-clip: text;\\n            -webkit-text-fill-color: transparent;\\n            background-clip: text;\\n            text-align: center;\\n            margin-bottom: 30px;\\n        }\\n        .section { \\n            margin: 25px 0; \\n            padding: 20px; \\n            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);\\n            border-radius: 12px; \\n            border-left: 4px solid #667eea;\\n            transition: transform 0.3s, box-shadow 0.3s;\\n        }\\n        .section:hover {\\n            transform: translateY(-2px);\\n            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);\\n        }\\n        .section h2 { \\n            margin-top: 0; \\n            color: #667eea; \\n            font-size: 20px;\\n            display: flex;\\n            align-items: center;\\n            gap: 10px;\\n        }\\n        label { \\n            display: block; \\n            margin: 15px 0 8px; \\n            color: #555; \\n            font-weight: 600;\\n            font-size: 14px;\\n        }\\n        input, textarea { \\n            width: 100%; \\n            padding: 12px; \\n            border: 2px solid #e0e0e0; \\n            border-radius: 8px; \\n            box-sizing: border-box;\\n            font-size: 14px;\\n            transition: border-color 0.3s, box-shadow 0.3s;\\n        }\\n        input:focus, textarea:focus {\\n            outline: none;\\n            border-color: #667eea;\\n            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);\\n        }\\n        button { \\n            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\\n            color: white; \\n            padding: 12px 24px; \\n            border: none; \\n            border-radius: 8px; \\n            cursor: pointer; \\n            margin: 8px 5px 8px 0;\\n            font-weight: 600;\\n            font-size: 14px;\\n            transition: transform 0.2s, box-shadow 0.3s;\\n            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);\\n        }\\n        button:hover { \\n            transform: translateY(-2px);\\n            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);\\n        }\\n        button:active {\\n            transform: translateY(0);\\n        }\\n        .alarm-item { \\n            padding: 15px; \\n            margin: 10px 0; \\n            background: white; \\n            border: 2px solid #e0e0e0; \\n            border-radius: 8px;\\n            transition: border-color 0.3s;\\n        }\\n        .alarm-item:hover {\\n            border-color: #667eea;\\n        }\\n        .delete-btn { \\n            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);\\n            float: right;\\n        }\\n        .delete-btn:hover { \\n            box-shadow: 0 6px 20px rgba(245, 87, 108, 0.4);\\n        }\\n        .status { \\n            padding: 15px; \\n            margin: 15px 0; \\n            border-radius: 8px;\\n            font-weight: 500;\\n            animation: slideDown 0.3s ease-out;\\n        }\\n        @keyframes slideDown {\\n            from { transform: translateY(-10px); opacity: 0; }\\n            to { transform: translateY(0); opacity: 1; }\\n        }\\n        .success { \\n            background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);\\n            color: #155724; \\n        }\\n        .error { \\n            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);\\n            color: #721c24; \\n        }\\n        .ota-section {\\n            background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);\\n            border-left-color: #f39c12;\\n        }\\n        .ota-section h2 {\\n            color: #d35400;\\n        }\\n        .warning-text {\\n            color: #d35400;\\n            font-size: 13px;\\n            margin-top: 10px;\\n            padding: 10px;\\n            background: rgba(255, 255, 255, 0.7);\\n            border-radius: 6px;\\n        }\\n        \\n        /* Responsive Design - Tablet (iPad) */\\n        @media screen and (max-width: 1024px) {\\n            body {\\n                padding: 15px;\\n            }\\n            .container {\\n                max-width: 90%;\\n                padding: 25px;\\n            }\\n            .contact-info {\\n                top: 15px;\\n                right: 15px;\\n                padding: 12px 16px;\\n                font-size: 14px;\\n            }\\n            h1 {\\n                font-size: 24px;\\n            }\\n            .section {\\n                padding: 18px;\\n            }\\n        }\\n        \\n        /* Responsive Design - Mobile (ƒêi·ªán tho·∫°i) */\\n        @media screen and (max-width: 768px) {\\n            body {\\n                padding: 10px;\\n                background-attachment: fixed;\\n            }\\n            .contact-info {\\n                position: fixed !important;\\n                top: 10px !important;\\n                right: 10px !important;\\n                left: auto !important;\\n                width: auto !important;\\n                max-width: calc(100% - 20px) !important;\\n                padding: 10px 12px !important;\\n                text-align: left !important;\\n                margin-bottom: 0 !important;\\n                font-size: 12px !important;\\n                z-index: 1000 !important;\\n            }\\n            .pwa-install-fixed {\\n                position: fixed !important;\\n                bottom: 10px !important;\\n                right: 10px !important;\\n                left: auto !important;\\n                width: auto !important;\\n                max-width: calc(100% - 20px) !important;\\n                padding: 10px 12px !important;\\n                font-size: 11px !important;\\n                z-index: 1000 !important;\\n            }\\n            .pwa-install-fixed button {\\n                font-size: 12px !important;\\n                padding: 10px 16px !important;\\n            }\\n            .pwa-install-fixed > div {\\n                font-size: 10px !important;\\n                margin-top: 4px !important;\\n            }\\n            .contact-info a {\\n                font-size: 12px !important;\\n                margin-bottom: 4px !important;\\n            }\\n            .contact-info .phone {\\n                font-size: 11px !important;\\n            }\\n            .container {\\n                max-width: 100%;\\n                padding: 20px 15px;\\n                border-radius: 12px;\\n                margin: 0;\\n            }\\n            h1 {\\n                font-size: 22px;\\n                margin-bottom: 20px;\\n                line-height: 1.3;\\n            }\\n            .section {\\n                margin: 20px 0;\\n                padding: 15px;\\n                border-radius: 10px;\\n            }\\n            .section h2 {\\n                font-size: 18px;\\n                flex-wrap: wrap;\\n            }\\n            label {\\n                margin: 12px 0 6px;\\n                font-size: 13px;\\n            }\\n            input, textarea {\\n                padding: 14px;\\n                font-size: 16px; /* Prevent zoom on iOS */\\n                border-radius: 8px;\\n            }\\n            button {\\n                width: 100%;\\n                padding: 14px 20px;\\n                margin: 8px 0;\\n                font-size: 16px;\\n                min-height: 44px; /* Minimum touch target size */\\n                -webkit-tap-highlight-color: rgba(102, 126, 234, 0.3);\\n            }\\n            .delete-btn {\\n                float: none;\\n                width: 100%;\\n                margin-top: 10px;\\n            }\\n            .alarm-item {\\n                padding: 12px;\\n                margin: 8px 0;\\n            }\\n            .status {\\n                padding: 12px;\\n                font-size: 14px;\\n            }\\n            .warning-text {\\n                font-size: 12px;\\n                padding: 8px;\\n            }\\n            /* Stack buttons vertically on mobile */\\n            #add-radio-form button,\\n            #add-alarm-form button {\\n                width: 100%;\\n                margin: 5px 0;\\n            }\\n            /* AI Chat input container for mobile */\\n            #ai_text_input {\\n                font-size: 20px !important; /* Larger font for mobile - must override inline */\\n                padding: 18px !important;\\n                min-height: 80px !important;\\n                line-height: 1.7 !important;\\n                width: 100% !important;\\n                box-sizing: border-box !important;\\n                flex: 1 1 auto !important;\\n            }\\n            /* Send button for AI chat on mobile */\\n            #send-button {\\n                padding: 18px 28px !important;\\n                min-width: 90px !important;\\n                min-height: 70px !important;\\n                font-size: 18px !important;\\n                white-space: nowrap;\\n                width: 100% !important;\\n                margin-top: 10px !important;\\n            }\\n            /* Chat input container wrapper for mobile - t√°ch th√†nh 2 d√≤ng */\\n            .section > div[style*=\"display: flex; gap: 10px; align-items: flex-end;\"] {\\n                flex-direction: column !important;\\n                align-items: stretch !important;\\n                gap: 12px !important;\\n            }\\n        }\\n        \\n        /* Small mobile devices */\\n        @media screen and (max-width: 480px) {\\n            body {\\n                padding: 8px;\\n            }\\n            .container {\\n                padding: 15px 12px;\\n            }\\n            h1 {\\n                font-size: 20px;\\n            }\\n            .section {\\n                padding: 12px;\\n            }\\n            .section h2 {\\n                font-size: 16px;\\n            }\\n            input, textarea {\\n                padding: 12px;\\n            }\\n            /* AI Chat textarea specific for small mobile */\\n            #ai_text_input {\\n                font-size: 22px !important; /* Even larger font for small mobile */\\n                padding: 20px !important;\\n                min-height: 90px !important;\\n                line-height: 1.7 !important;\\n                width: 100% !important;\\n                box-sizing: border-box !important;\\n                flex: 1 1 auto !important;\\n            }\\n            /* Chat input container for mobile */\\n            #ai_text_input + button {\\n                flex-shrink: 0;\\n            }\\n            button {\\n                padding: 14px 18px;\\n                font-size: 16px;\\n            }\\n            /* Send button for AI chat on small mobile */\\n            #send-button {\\n                padding: 20px 30px !important;\\n                min-width: 100px !important;\\n                min-height: 90px !important;\\n                font-size: 18px !important;\\n                white-space: nowrap;\\n                width: 100% !important;\\n                margin-top: 12px !important;\\n            }\\n            /* Chat input container wrapper for small mobile - t√°ch th√†nh 2 d√≤ng */\\n            .section > div[style*=\"display: flex; gap: 10px; align-items: flex-end;\"] {\\n                flex-direction: column !important;\\n                align-items: stretch !important;\\n                gap: 15px !important;\\n            }\\n        }\\n        \\n        /* Landscape orientation on mobile */\\n        @media screen and (max-width: 768px) and (orientation: landscape) {\\n            .contact-info {\\n                position: fixed;\\n                top: 10px;\\n                right: 10px;\\n                width: auto;\\n                max-width: 200px;\\n                padding: 10px 12px;\\n            }\\n            .container {\\n                margin-top: 60px;\\n            }\\n        }\\n        \\n        /* Touch device optimizations */\\n        @media (hover: none) and (pointer: coarse) {\\n            button:hover {\\n                transform: none;\\n            }\\n            .section:hover {\\n                transform: none;\\n            }\\n            button:active {\\n                transform: scale(0.98);\\n                opacity: 0.9;\\n            }\\n        }\\n        \\n        /* PWA Install Banner Animation */\\n        @keyframes slideUp {\\n            from {\\n                transform: translateY(100%);\\n                opacity: 0;\\n            }\\n            to {\\n                transform: translateY(0);\\n                opacity: 1;\\n            }\\n        }\\n        \\n        #pwa-install-banner {\\n            font-family: \'Segoe UI\', Tahoma, Geneva, Verdana, sans-serif;\\n        }\\n        \\n        @media screen and (max-width: 768px) {\\n            #pwa-install-banner {\\n                padding: 12px 15px;\\n            }\\n            #pwa-install-banner > div > div:first-child {\\n                font-size: 14px;\\n            }\\n            #pwa-install-banner > div > div:first-child > div:last-child {\\n                font-size: 12px;\\n            }\\n            #pwa-install-btn, #pwa-install-banner button {\\n                padding: 8px 16px;\\n                font-size: 13px;\\n            }\\n            .contact-info { position: fixed; top: 10px; right: 10px; background: rgba(255,255,255,0.95); padding: 10px 12px; border-radius: 12px; font-size: 12px; z-index: 1000; }\\n            .container { max-width: 700px; margin: 0 auto; background: white; padding: 30px; border-radius: 16px; }\\n            .section { margin: 20px 0; padding: 20px; background: white; border-radius: 12px; }\\n            button { padding: 12px 24px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; }\\n        </style>\\n    </noscript>\\n    <!-- PWA Configuration -->\\n    <link rel=\"manifest\" href=\"/manifest.json\">\\n    <meta name=\"theme-color\" content=\"#667eea\">\\n    <meta name=\"apple-mobile-web-app-capable\" content=\"yes\">\\n    <meta name=\"apple-mobile-web-app-status-bar-style\" content=\"black-translucent\">\\n    <meta name=\"apple-mobile-web-app-title\" content=\"Xiaozhi Settings\">\\n    <meta name=\"mobile-web-app-capable\" content=\"yes\">\\n    <meta name=\"description\" content=\"Xiaozhi Settings - Configure your Xiaozhi device\">\\n</head>\\n<body>\\n    <div class=\"contact-info\">\\n        <a href=\"http://kytuoi.com\" target=\"_blank\">üåê kytuoi.com</a>\\n        <div class=\"phone\">üìû 0345995569</div>\\n    </div>\\n    <div class=\"lang-selector\">\\n        <label for=\"language\">üåê</label>\\n        <select id=\"language\" onchange=\"changeLanguage(this.value)\">\\n            <option value=\"zh-CN\">‰∏≠Êñá (ÁÆÄ‰Ωì)</option>\\n            <option value=\"zh-TW\">‰∏≠Êñá (ÁπÅÈ´î)</option>\\n            <option value=\"en-US\">English</option>\\n            <option value=\"ja-JP\">Êó•Êú¨Ë™û</option>\\n            <option value=\"ko-KR\">ÌïúÍµ≠Ïñ¥</option>\\n            <option value=\"vi-VN\">Ti·∫øng Vi·ªát</option>\\n            <option value=\"th-TH\">‡πÑ‡∏ó‡∏¢</option>\\n        </select>\\n    </div>\\n    <div class=\"container\">\\n        <h1 data-i18n=\"settings.title\">‚öôÔ∏è Xiaozhi Settings</h1>\\n        <div id=\"status\"></div>\\n        \\n        <div class=\"section\" style=\"background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); border-left: 4px solid #667eea;\">\\n            <h2 style=\"color: #667eea; margin-bottom: 15px;\">üí¨ AI Chat</h2>\\n            \\n            <!-- Chat Container -->\\n            <div id=\"chat-container\" style=\"background: white; border-radius: 12px; height: 400px; max-height: 60vh; overflow-y: auto; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: flex; flex-direction: column;\">\\n                <div id=\"chat-messages\" style=\"flex: 1; overflow-y: auto; padding-bottom: 10px;\">\\n                    <!-- Messages will be added here -->\\n                    <div style=\"text-align: center; color: #999; padding: 20px; font-size: 14px;\">\\n                        üí¨ B·∫Øt ƒë·∫ßu cu·ªôc tr√≤ chuy·ªán v·ªõi AI...\\n                    </div>\\n                </div>\\n                \\n                <!-- Typing Indicator -->\\n                <div id=\"typing-indicator\" style=\"display: none; padding: 10px; color: #667eea; font-style: italic; font-size: 14px;\">\\n                    <span style=\"display: inline-block; animation: typing 1.4s infinite;\">\\n                        AI ƒëang suy nghƒ©<span id=\"typing-dots\">...</span>\\n                    </span>\\n                </div>\\n            </div>\\n            \\n            <!-- Chat Input -->\\n            <div style=\"display: flex; gap: 10px; align-items: flex-end;\">\\n                <textarea id=\"ai_text_input\" placeholder=\"Nh·∫≠p tin nh·∫Øn... (Enter ƒë·ªÉ g·ª≠i, Shift+Enter ƒë·ªÉ xu·ªëng d√≤ng)\" \\n                          rows=\"2\" \\n                          style=\"flex: 1; padding: 12px; border: 2px solid #ddd; border-radius: 20px; font-size: 18px; resize: none; font-family: inherit; outline: none; transition: border-color 0.3s; min-height: 70px; line-height: 1.7; box-sizing: border-box; width: 100%;\"\\n                          onfocus=\"this.style.borderColor=\'#667eea\';\"\\n                          onblur=\"this.style.borderColor=\'#ddd\';\"></textarea>\\n                <button onclick=\"sendTextToAI()\" \\n                        id=\"send-button\"\\n                        style=\"padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 20px; font-weight: bold; cursor: pointer; transition: all 0.3s; min-width: 80px;\"\\n                        onmouseover=\"this.style.transform=\'translateY(-2px)\'; this.style.boxShadow=\'0 4px 12px rgba(102, 126, 234, 0.4)\';\"\\n                        onmouseout=\"this.style.transform=\'translateY(0)\'; this.style.boxShadow=\'none\';\">\\n                    üì§ G·ª≠i\\n                </button>\\n            </div>\\n            \\n            <!-- Clear Chat Button -->\\n            <div style=\"margin-top: 10px; text-align: right;\">\\n                <button onclick=\"clearChat()\" \\n                        style=\"padding: 8px 16px; background: #f0f0f0; color: #666; border: 1px solid #ddd; border-radius: 8px; font-size: 12px; cursor: pointer; transition: all 0.3s;\"\\n                        onmouseover=\"this.style.background=\'#e0e0e0\';\"\\n                        onmouseout=\"this.style.background=\'#f0f0f0\';\">\\n                    üóëÔ∏è X√≥a l·ªãch s·ª≠\\n                </button>\\n            </div>\\n        </div>\\n        \\n        <div class=\"section\" style=\"background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-left: 4px solid #667eea;\">\\n            <h2 style=\"color: white;\">ü§ñ Otto Robot Control</h2>\\n            <div style=\"margin: 15px 0;\">\\n                <a href=\"/otto\" style=\"display: inline-block; padding: 12px 24px; background: white; color: #667eea; text-decoration: none; border-radius: 8px; font-weight: bold; margin-right: 10px; transition: all 0.3s;\" onmouseover=\"this.style.background=\'#f0f0f0\'; this.style.transform=\'translateY(-2px)\';\" onmouseout=\"this.style.background=\'white\'; this.style.transform=\'translateY(0)\';\">\\n                    ü§ñ Otto Control\\n                </a>\\n                <a href=\"/servo-calibration\" style=\"display: inline-block; padding: 12px 24px; background: #ff9800; color: white; text-decoration: none; border-radius: 8px; font-weight: bold; transition: all 0.3s;\" onmouseover=\"this.style.background=\'#f57c00\'; this.style.transform=\'translateY(-2px)\';\" onmouseout=\"this.style.background=\'#ff9800\'; this.style.transform=\'translateY(0)\';\">\\n                    ‚öôÔ∏è Servo Calibration\\n                </a>\\n            </div>\\n            <div style=\"font-size: 12px; color: rgba(255,255,255,0.9); margin-top: 10px;\">\\n                ƒêi·ªÅu khi·ªÉn robot Otto v√† ƒëi·ªÅu ch·ªânh g√≥c servo\\n            </div>\\n        </div>\\n        \\n        <div class=\"section\">\\n            <h2>Music Server</h2>\\n            <div class=\"portal-music-box\" id=\"portal-music-box\">\\n                <div id=\"portal-music-status\" class=\"portal-music-status\">üîÑ ƒêang ki·ªÉm tra ƒëƒÉng k√Ω VIP...</div>\\n                <div id=\"portal-music-list\" class=\"portal-music-list\"></div>\\n            </div>\\n            <label>Server URL:</label>\\n            <input type=\"text\" id=\"music_server_url\" placeholder=\"http://www.xiaozhishop.xyz:5005\">\\n            <button onclick=\"saveSettings()\">Save Settings</button>\\n        </div>\\n        \\n        <div class=\"section\">\\n            <h2>‚ö° Ti·∫øt Ki·ªám Pin (Power Save)</h2>\\n            <label>\\n                <input type=\"checkbox\" id=\"sleep_mode\" style=\"width: auto; margin-right: 8px;\">\\n                B·∫≠t ch·∫ø ƒë·ªô ti·∫øt ki·ªám pin t·ª± ƒë·ªông\\n            </label>\\n            <div style=\"font-size: 12px; color: #666; margin-top: 8px;\">\\n                Khi b·∫≠t: Sau 60 gi√¢y kh√¥ng s·ª≠ d·ª•ng s·∫Ω v√†o ch·∫ø ƒë·ªô sleep (gi·∫£m ƒë·ªô s√°ng), sau 10 gi·ªù s·∫Ω t·ª± ƒë·ªông t·∫Øt m√°y. Ch·∫ø ƒë·ªô n√†y ch·ªâ ho·∫°t ƒë·ªông khi ƒëang x·∫£ pin (kh√¥ng s·∫°c).\\n            </div>\\n            <button onclick=\"saveSettings()\">Save Settings</button>\\n        </div>\\n        \\n        <div class=\"section\">\\n            <h2>üé§ ƒê·ªô Nh·∫°y Wake Word (Wake Word Sensitivity)</h2>\\n            <div style=\"margin-bottom: 8px;\">\\n                <label for=\"wake_word_sensitivity\" style=\"display: block; margin-bottom: 8px;\">\\n                    ƒê·ªô nh·∫°y microphone: <span id=\"wake_word_sensitivity_value\">1.0</span>x (<span id=\"wake_word_sensitivity_db\">0</span>dB)\\n                </label>\\n                <input type=\"range\" id=\"wake_word_sensitivity\" min=\"1.0\" max=\"5.0\" step=\"0.1\" value=\"1.0\" \\n                       style=\"width: 100%; height: 8px; border-radius: 5px; background: #ddd; outline: none;\"\\n                       oninput=\"updateWakeWordSensitivity()\">\\n                <div style=\"display: flex; justify-content: space-between; font-size: 11px; color: #666; margin-top: 4px;\">\\n                    <span>1.0x (0dB) - M·∫∑c ƒë·ªãnh (nh∆∞ code g·ªëc)</span>\\n                    <span>3.5x (11dB) - Khuy·∫øn ngh·ªã n·∫øu k√©m nh·∫°y</span>\\n                    <span>5.0x (14dB) - R·∫•t nh·∫°y</span>\\n                </div>\\n            </div>\\n            <div style=\"font-size: 12px; color: #666; margin-top: 8px;\">\\n                ƒêi·ªÅu ch·ªânh ƒë·ªô nh·∫°y c·ªßa microphone cho wake word detection. M·∫∑c ƒë·ªãnh: 1.0x (nh∆∞ code g·ªëc, kh√¥ng c√≥ amplification). N·∫øu wake word detection k√©m, c√≥ th·ªÉ tƒÉng l√™n 3.5x - 4.0x. Gi√° tr·ªã cao h∆°n = nh·∫°y h∆°n nh∆∞ng c√≥ th·ªÉ b·ªã false positives.\\n            </div>\\n            <button onclick=\"saveSettings()\">Save Settings</button>\\n        </div>\\n        \\n        <div class=\"section\">\\n            <h2>üéôÔ∏è ƒêi·ªÅu Ch·ªânh Microphone & Gi·∫£m Nhi·ªÖu</h2>\\n            <div style=\"margin-bottom: 16px;\">\\n                <label for=\"vad_mode\" style=\"display: block; margin-bottom: 8px;\">\\n                    VAD Mode (Voice Activity Detection Mode):\\n                </label>\\n                <select id=\"vad_mode\" style=\"width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;\">\\n                    <option value=\"0\">Mode 0 - Nh·∫°y nh·∫•t (m·∫∑c ƒë·ªãnh, d·ªÖ false positives)</option>\\n                    <option value=\"1\">Mode 1 - Nh·∫°y (gi·∫£m false positives m·ªôt ph·∫ßn)</option>\\n                    <option value=\"2\">Mode 2 - V·ª´a (c√¢n b·∫±ng)</option>\\n                    <option value=\"3\">Mode 3 - √çt nh·∫°y (gi·∫£m nhi·ªÅu false positives, c√≥ th·ªÉ miss speech)</option>\\n                </select>\\n                <div style=\"font-size: 12px; color: #666; margin-top: 4px;\">\\n                    ƒêi·ªÅu ch·ªânh ƒë·ªô nh·∫°y c·ªßa Voice Activity Detection. Mode th·∫•p h∆°n = nh·∫°y h∆°n nh∆∞ng c√≥ th·ªÉ nh·∫≠n nh·∫ßm ti·∫øng ·ªìn l√† gi·ªçng n√≥i. Mode cao h∆°n = √≠t false positives h∆°n nh∆∞ng c√≥ th·ªÉ b·ªè s√≥t m·ªôt s·ªë gi·ªçng n√≥i. ‚ö†Ô∏è C·∫ßn kh·ªüi ƒë·ªông l·∫°i thi·∫øt b·ªã ƒë·ªÉ √°p d·ª•ng.\\n                </div>\\n            </div>\\n            \\n            <div style=\"margin-bottom: 16px;\">\\n                <label for=\"vad_min_noise_ms\" style=\"display: block; margin-bottom: 8px;\">\\n                    VAD Min Noise Duration: <span id=\"vad_min_noise_ms_value\">100</span>ms\\n                </label>\\n                <input type=\"range\" id=\"vad_min_noise_ms\" min=\"100\" max=\"500\" step=\"50\" value=\"100\" \\n                       style=\"width: 100%; height: 8px; border-radius: 5px; background: #ddd; outline: none;\"\\n                       oninput=\"updateVadMinNoiseMs()\">\\n                <div style=\"display: flex; justify-content: space-between; font-size: 11px; color: #666; margin-top: 4px;\">\\n                    <span>100ms - M·∫∑c ƒë·ªãnh</span>\\n                    <span>500ms - Ch·ªù l√¢u h∆°n</span>\\n                </div>\\n                <div style=\"font-size: 12px; color: #666; margin-top: 4px;\">\\n                    Th·ªùi gian t·ªëi thi·ªÉu ƒë·ªÉ VAD ph√°t hi·ªán silence. Gi√° tr·ªã cao h∆°n = ch·ªù l√¢u h∆°n tr∆∞·ªõc khi ph√°t hi·ªán im l·∫∑ng, h·ªØu √≠ch khi c√≥ nhi·ªÅu kho·∫£ng d·ª´ng ng·∫Øn trong c√¢u n√≥i. ‚ö†Ô∏è C·∫ßn kh·ªüi ƒë·ªông l·∫°i thi·∫øt b·ªã ƒë·ªÉ √°p d·ª•ng.\\n                </div>\\n            </div>\\n            \\n            <div style=\"margin-bottom: 16px;\">\\n                <label>\\n                    <input type=\"checkbox\" id=\"noise_suppression_enabled\" style=\"width: auto; margin-right: 8px;\">\\n                    B·∫≠t Noise Suppression (Gi·∫£m Nhi·ªÖu)\\n                </label>\\n                <div style=\"font-size: 12px; color: #666; margin-top: 4px;\">\\n                    B·∫≠t/t·∫Øt t√≠nh nƒÉng gi·∫£m nhi·ªÖu (noise suppression) ƒë·ªÉ c·∫£i thi·ªán ch·∫•t l∆∞·ª£ng gi·ªçng n√≥i trong m√¥i tr∆∞·ªùng ·ªìn. M·∫∑c ƒë·ªãnh: B·∫≠t. ‚ö†Ô∏è C·∫ßn kh·ªüi ƒë·ªông l·∫°i thi·∫øt b·ªã ƒë·ªÉ √°p d·ª•ng.\\n                </div>\\n            </div>\\n            \\n            <div style=\"background-color: #fff3cd; border: 1px solid #ffc107; border-radius: 4px; padding: 12px; margin-top: 16px;\">\\n                <strong>‚ö†Ô∏è L∆∞u √Ω:</strong> C√°c settings VAD Mode, VAD Min Noise Duration v√† Noise Suppression c·∫ßn kh·ªüi ƒë·ªông l·∫°i thi·∫øt b·ªã ƒë·ªÉ √°p d·ª•ng v√¨ ch√∫ng ƒë∆∞·ª£c c·∫•u h√¨nh khi kh·ªüi t·∫°o audio processor.\\n            </div>\\n            \\n            <button onclick=\"saveSettings()\" style=\"margin-top: 16px;\">Save Settings</button>\\n        </div>\\n        \\n        <div class=\"section\">\\n            <h2>üéµ Wake Word Khi Ph√°t Nh·∫°c/Radio</h2>\\n            <label>\\n                <input type=\"checkbox\" id=\"wake_word_during_music\" style=\"width: auto; margin-right: 8px;\">\\n                B·∫≠t wake word detection khi ƒëang ph√°t nh·∫°c ho·∫∑c radio\\n            </label>\\n            <div style=\"font-size: 12px; color: #666; margin-top: 8px;\">\\n                Khi b·∫≠t: Wake word detection s·∫Ω ho·∫°t ƒë·ªông ngay c·∫£ khi ƒëang ph√°t nh·∫°c ho·∫∑c radio. Khi t·∫Øt: Wake word detection s·∫Ω b·ªã t·∫Øt khi ƒëang ph√°t nh·∫°c/radio ƒë·ªÉ tr√°nh false positives do ti·∫øng nh·∫°c. M·∫∑c ƒë·ªãnh: B·∫≠t (true).\\n            </div>\\n            <button onclick=\"saveSettings()\">Save Settings</button>\\n        </div>\\n        \\n        <div class=\"section\">\\n            <h2>Radio Channels</h2>\\n            <div class=\"portal-radio-box\" id=\"portal-radio-box\">\\n                <div id=\"portal-radio-status\" class=\"portal-radio-status\">üîÑ ƒêang ki·ªÉm tra ƒëƒÉng k√Ω VIP...</div>\\n                <div id=\"portal-radio-list\" class=\"portal-radio-list\"></div>\\n            </div>\\n            <div id=\"radio-channels-list\"></div>\\n            <button onclick=\"showAddRadioChannel()\">+ Add Channel</button>\\n            <div id=\"add-radio-form\" style=\"display:none; margin-top:15px;\">\\n                <label>Title:</label>\\n                <input type=\"text\" id=\"new_radio_title\" placeholder=\"VOV1\">\\n                <label>URL:</label>\\n                <input type=\"text\" id=\"new_radio_url\" placeholder=\"http://...\">\\n                <label>Artist (optional):</label>\\n                <input type=\"text\" id=\"new_radio_artist\" placeholder=\"VOV\">\\n                <button onclick=\"addRadioChannel()\">Add</button>\\n                <button onclick=\"hideAddRadioChannel()\">Cancel</button>\\n            </div>\\n            <button onclick=\"saveRadioChannels()\" style=\"margin-top:10px;\">Save All Channels</button>\\n        </div>\\n        \\n        <div class=\"section\">\\n            <h2>üì± QR Code Management</h2>\\n            <label>QR Display Duration (seconds, 10-120):</label>\\n            <input type=\"number\" id=\"qr_duration\" placeholder=\"40\" min=\"10\" max=\"120\">\\n            <small>Th·ªùi gian hi·ªÉn th·ªã QR code tr√™n LCD (m·∫∑c ƒë·ªãnh: 40 gi√¢y)</small>\\n            <div id=\"qr-codes-list\" style=\"margin-top: 15px;\"></div>\\n            <button onclick=\"showAddQrCode()\" style=\"margin-top: 10px;\">+ Add QR Code</button>\\n            <div id=\"add-qr-form\" style=\"display:none; margin-top:15px;\">\\n                <label>Name:</label>\\n                <input type=\"text\" id=\"new_qr_name\" placeholder=\"My QR Code\" maxlength=\"50\">\\n                <label>QR Data/URL:</label>\\n                <textarea id=\"new_qr_data\" placeholder=\"http://example.com or any text\" rows=\"3\" maxlength=\"500\"></textarea>\\n                <button onclick=\"addQrCode()\">Add</button>\\n                <button onclick=\"hideAddQrCode()\">Cancel</button>\\n            </div>\\n            <button onclick=\"saveQrSettings()\" style=\"margin-top:10px;\">Save QR Settings</button>\\n        </div>\\n        \\n        <div class=\"section\">\\n            <h2>Alarm Music</h2>\\n            <label>Alarm Music URL:</label>\\n            <input type=\"text\" id=\"alarm_music_url\" placeholder=\"URL for alarm music\">\\n            <label>Alarm Timeout (seconds, 30-600):</label>\\n            <input type=\"number\" id=\"alarm_timeout\" placeholder=\"120\" min=\"30\" max=\"600\">\\n            <small>Th·ªùi gian ph√°t nh·∫°c b√°o th·ª©c li√™n t·ª•c (m·∫∑c ƒë·ªãnh: 120 gi√¢y = 2 ph√∫t)</small>\\n            <button onclick=\"saveAlarmMusic()\">Save Alarm Music</button>\\n        </div>\\n        \\n        <div class=\"section\">\\n            <h2>Alarms</h2>\\n            <div id=\"alarms-list\"></div>\\n            <button onclick=\"showAddAlarm()\">+ Add Alarm</button>\\n            <div id=\"add-alarm-form\" style=\"display:none; margin-top:15px;\">\\n                <label>Time (HH:MM):</label>\\n                <input type=\"text\" id=\"new_alarm_time\" placeholder=\"08:00\">\\n                <label>Days (comma-separated, 1=Mon, 7=Sun):</label>\\n                <input type=\"text\" id=\"new_alarm_days\" placeholder=\"1,2,3,4,5\">\\n                <label>Message:</label>\\n                <input type=\"text\" id=\"new_alarm_message\" placeholder=\"Wake up!\">\\n                <button onclick=\"addAlarm()\">Add</button>\\n                <button onclick=\"hideAddAlarm()\">Cancel</button>\\n            </div>\\n        </div>\\n        \\n        <div class=\"section ota-section\">\\n            <h2>üöÄ OTA N√¢ng Cao (Firmware Upgrade)</h2>\\n            <div class=\"portal-ota-box\" id=\"portal-ota-box\">\\n                <div id=\"portal-ota-status\" class=\"portal-radio-status\">üîÑ ƒêang ki·ªÉm tra ƒëƒÉng k√Ω VIP...</div>\\n                <div id=\"portal-ota-list\" class=\"portal-radio-list\"></div>\\n            </div>\\n            <label>Firmware URL:</label>\\n            <input type=\"text\" id=\"ota_firmware_url\" placeholder=\"https://example.com/firmware/xiaozhi.bin\">\\n            <div class=\"warning-text\">\\n                ‚ö†Ô∏è C·∫£nh b√°o: N√¢ng c·∫•p firmware s·∫Ω kh·ªüi ƒë·ªông l·∫°i thi·∫øt b·ªã. ƒê·∫£m b·∫£o URL firmware h·ª£p l·ªá v√† thi·∫øt b·ªã c√≥ k·∫øt n·ªëi m·∫°ng ·ªïn ƒë·ªãnh.\\n            </div>\\n            <button onclick=\"upgradeFirmware()\" style=\"background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);\">Upgrade Firmware</button>\\n            <div id=\"ota-status\" style=\"margin-top:10px; padding:10px; background:rgba(255,255,255,0.7); border-radius:6px; display:none;\"></div>\\n        </div>\\n        \\n        <div class=\"section ota-section\">\\n            <h2>üì¶ Upgrade Assets (Models, Fonts, Sounds)</h2>\\n            <div class=\"portal-ota-box\" id=\"portal-assets-box\">\\n                <div id=\"portal-assets-status\" class=\"portal-radio-status\">üîÑ ƒêang ki·ªÉm tra ƒëƒÉng k√Ω VIP...</div>\\n                <div id=\"portal-assets-list\" class=\"portal-radio-list\"></div>\\n            </div>\\n            <label>Assets URL:</label>\\n            <input type=\"text\" id=\"assets_url\" placeholder=\"https://example.com/assets/generated_assets.bin\">\\n            <div class=\"warning-text\">\\n                ‚ö†Ô∏è L∆∞u √Ω: Upgrade assets s·∫Ω t·∫£i v√† flash file assets m·ªõi (models, fonts, sounds). Thi·∫øt b·ªã s·∫Ω t·ª± ƒë·ªông reload sau khi ho√†n t·∫•t.\\n            </div>\\n            <button onclick=\"upgradeAssets()\" style=\"background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);\">Upgrade Assets</button>\\n            <div id=\"assets-status\" style=\"margin-top:10px; padding:10px; background:rgba(255,255,255,0.7); border-radius:6px; display:none;\"></div>\\n        </div>\\n        \\n        <div class=\"section\">\\n            <button onclick=\"location.reload()\">Refresh</button>\\n        </div>\\n        \\n        <!-- Device Information Section -->\\n        <div class=\"section\" style=\"margin-top: 30px; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); border: 2px solid #667eea; border-radius: 12px; padding: 20px;\">\\n            <h2 style=\"color: #667eea; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;\">\\n                <span>üì±</span>\\n                <span>Th√¥ng Tin Thi·∫øt B·ªã (Device Information)</span>\\n            </h2>\\n            <div id=\"device-info\" style=\"background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);\">\\n                <div style=\"display: flex; align-items: center; gap: 10px; margin-bottom: 10px;\">\\n                    <strong style=\"color: #333; min-width: 120px;\">MAC Address:</strong>\\n                    <span id=\"mac-address\" style=\"font-family: \'Courier New\', monospace; font-size: 16px; color: #667eea; font-weight: bold; padding: 5px 10px; background: #f0f0f0; border-radius: 4px;\">\\n                        ƒêang t·∫£i...\\n                    </span>\\n                    <button onclick=\"copyMacAddress(event)\" style=\"background: #667eea; color: white; border: none; padding: 5px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; transition: all 0.3s;\" \\n                            onmouseover=\"this.style.background=\'#764ba2\';\" \\n                            onmouseout=\"this.style.background=\'#667eea\';\">\\n                        üìã Copy\\n                    </button>\\n                </div>\\n                <div style=\"display: flex; align-items: center; gap: 10px; margin-bottom: 10px;\">\\n                    <strong style=\"color: #333; min-width: 120px;\">IP Address:</strong>\\n                    <span id=\"ip-address\" style=\"font-family: \'Courier New\', monospace; font-size: 14px; color: #333;\">\\n                        ƒêang t·∫£i...\\n                    </span>\\n                </div>\\n                <div style=\"display: flex; align-items: center; gap: 10px;\">\\n                    <strong style=\"color: #333; min-width: 120px;\">Device ID:</strong>\\n                    <span id=\"device-id\" style=\"font-family: \'Courier New\', monospace; font-size: 14px; color: #333;\">\\n                        ƒêang t·∫£i...\\n                    </span>\\n                </div>\\n            </div>\\n        </div>\\n    </div>\\n    \\n    <!-- Fixed PWA Install Button (Bottom Right Corner) -->\\n    <div class=\"pwa-install-fixed\" id=\"pwa-install-button-fixed\" style=\"position: fixed; bottom: 20px; right: 20px; background: rgba(255, 255, 255, 0.95); padding: 15px 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 1000; backdrop-filter: blur(10px); text-align: center;\">\\n        <button onclick=\"installPWA()\" style=\"background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 12px 20px; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 14px; transition: all 0.3s; box-shadow: 0 2px 8px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center; gap: 8px; white-space: nowrap;\" \\n                onmouseover=\"this.style.transform=\'translateY(-2px)\'; this.style.boxShadow=\'0 4px 12px rgba(0,0,0,0.3)\';\" \\n                onmouseout=\"this.style.transform=\'translateY(0)\'; this.style.boxShadow=\'0 2px 8px rgba(0,0,0,0.2)\';\">\\n            üì± C√†i ƒë·∫∑t ·ª©ng d·ª•ng\\n        </button>\\n        <div style=\"font-size: 11px; color: #666; margin-top: 6px;\">\\n            Install App\\n        </div>\\n    </div>\\n    <script>\\n        // Hide PWA install button if on GitHub Pages App page or PWA is already installed\\n        (function() {\\n            function shouldHidePWAButton() {\\n                // Check if on GitHub Pages App page\\n                const currentHost = window.location.hostname;\\n                if (currentHost === \'nguenvanky.github.io\' && window.location.pathname.startsWith(\'/App/\')) {\\n                    return true;\\n                }\\n                // Check if PWA is already installed - standalone mode\\n                if (window.matchMedia(\'(display-mode: standalone)\').matches) {\\n                    return true;\\n                }\\n                // Check iOS standalone mode\\n                if (window.navigator.standalone === true) {\\n                    return true;\\n                }\\n                // Check Android app mode\\n                if (document.referrer && document.referrer.includes(\'android-app://\')) {\\n                    return true;\\n                }\\n                // Additional check: window.navigator.standalone on iOS\\n                if (typeof navigator !== \'undefined\' && navigator.standalone === true) {\\n                    return true;\\n                }\\n                return false;\\n            }\\n            \\n            function hidePWAButton() {\\n                const pwaInstallButton = document.getElementById(\'pwa-install-button-fixed\') || document.querySelector(\'.pwa-install-fixed\');\\n                if (pwaInstallButton && shouldHidePWAButton()) {\\n                    console.log(\'Hiding PWA install button - on App page or PWA installed\');\\n                    pwaInstallButton.style.display = \'none\';\\n                    pwaInstallButton.style.visibility = \'hidden\';\\n                    return true;\\n                }\\n                return false;\\n            }\\n            \\n            // Try to hide immediately\\n            if (document.readyState === \'loading\') {\\n                document.addEventListener(\'DOMContentLoaded\', function() {\\n                    hidePWAButton();\\n                    // Check again after a short delay\\n                    setTimeout(hidePWAButton, 100);\\n                    setTimeout(hidePWAButton, 500);\\n                    setTimeout(hidePWAButton, 1000);\\n                });\\n            } else {\\n                // DOM already loaded\\n                hidePWAButton();\\n                setTimeout(hidePWAButton, 100);\\n                setTimeout(hidePWAButton, 500);\\n                setTimeout(hidePWAButton, 1000);\\n            }\\n            \\n            // Listen for visibility change (when app goes to foreground/background)\\n            document.addEventListener(\'visibilitychange\', function() {\\n                if (!document.hidden) {\\n                    hidePWAButton();\\n                }\\n            });\\n            \\n            // Listen for appinstalled event\\n            window.addEventListener(\'appinstalled\', function() {\\n                console.log(\'PWA installed - hiding button\');\\n                hidePWAButton();\\n            });\\n            \\n            // Check periodically (every 2 seconds for first 10 seconds)\\n            let checkCount = 0;\\n            const checkInterval = setInterval(function() {\\n                if (hidePWAButton() || checkCount >= 5) {\\n                    clearInterval(checkInterval);\\n                }\\n                checkCount++;\\n            }, 2000);\\n        })();\\n    </script>\\n    \\n    <!-- PWA Install Banner -->\\n    <div id=\"pwa-install-banner\" style=\"display: none; position: fixed; bottom: 0; left: 0; right: 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 20px; box-shadow: 0 -4px 20px rgba(0,0,0,0.3); z-index: 10000; animation: slideUp 0.3s ease-out;\">\\n        <div style=\"max-width: 700px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px;\">\\n            <div style=\"flex: 1; min-width: 200px;\">\\n                <div style=\"font-weight: bold; font-size: 16px; margin-bottom: 5px;\">üì± C√†i ƒë·∫∑t ·ª©ng d·ª•ng</div>\\n                <div style=\"font-size: 13px; opacity: 0.9;\">C√†i ƒë·∫∑t ƒë·ªÉ truy c·∫≠p nhanh h∆°n v√† s·ª≠ d·ª•ng offline</div>\\n            </div>\\n            <div style=\"display: flex; gap: 10px; flex-wrap: wrap;\">\\n                <button id=\"pwa-install-btn\" onclick=\"installPWA()\" style=\"background: white; color: #667eea; border: none; padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 14px; transition: all 0.3s; box-shadow: 0 2px 8px rgba(0,0,0,0.2);\" onmouseover=\"this.style.transform=\'translateY(-2px)\'; this.style.boxShadow=\'0 4px 12px rgba(0,0,0,0.3)\';\" onmouseout=\"this.style.transform=\'translateY(0)\'; this.style.boxShadow=\'0 2px 8px rgba(0,0,0,0.2)\';\">\\n                    C√†i ƒë·∫∑t ngay\\n                </button>\\n                <button onclick=\"dismissPWA()\" style=\"background: transparent; color: white; border: 2px solid white; padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 14px; transition: all 0.3s;\" onmouseover=\"this.style.background=\'rgba(255,255,255,0.2)\';\" onmouseout=\"this.style.background=\'transparent\';\">\\n                    ƒê√≥ng\\n                </button>\\n            </div>\\n        </div>\\n    </div>\\n    \\n    <!-- Load JS from external -->\\n    <script>\\n        // Fallback loader functions\\n        function loadFallbackCSS(name) {\\n            console.warn(\'External CSS failed, trying fallback:\', name);\\n            const link = document.createElement(\'link\');\\n            link.rel = \'stylesheet\';\\n            link.href = \'/static/css/\' + name + \'.min.css\';\\n            link.onerror = function() {\\n                console.error(\'All CSS loading methods failed for:\', name);\\n            };\\n            document.head.appendChild(link);\\n        }\\n        \\n        function loadFallbackJS(name) {\\n            console.warn(\'External JS failed, trying fallback:\', name);\\n            const script = document.createElement(\'script\');\\n            script.src = \'/static/js/\' + name + \'.min.js\';\\n            script.onerror = function() {\\n                console.error(\'All JS loading methods failed for:\', name);\\n            };\\n            document.body.appendChild(script);\\n        }\\n        \\n        // Minimal functions needed before external JS loads\\n        function showStatus(message, isError) {\\n            const status = document.getElementById(\'status\');\\n            if (status) {\\n                status.className = \'status \' + (isError ? \'error\' : \'success\');\\n                status.textContent = message;\\n                setTimeout(() => status.textContent = \'\', 3000);\\n            }\\n        }\\n        \\n        function showAddAlarm() {\\n            document.getElementById(\'add-alarm-form\').style.display = \'block\';\\n        }\\n        \\n        function hideAddAlarm() {\\n            document.getElementById(\'add-alarm-form\').style.display = \'none\';\\n        }\\n        \\n        // PWA Install functions (minimal fallback)\\n        function isOnAppPage() {\\n            const currentHost = window.location.hostname;\\n            return currentHost === \'nguenvanky.github.io\' && window.location.pathname.startsWith(\'/App/\');\\n        }\\n        \\n        function isPWAInstalled() {\\n            // Check if running as PWA\\n            if (window.matchMedia(\'(display-mode: standalone)\').matches ||\\n                window.navigator.standalone === true ||\\n                document.referrer.includes(\'android-app://\')) {\\n                return true;\\n            }\\n            // Check if on GitHub Pages App URL\\n            const currentHost = window.location.hostname;\\n            if (currentHost === \'nguenvanky.github.io\' && window.location.pathname.startsWith(\'/App/\')) {\\n                return true;\\n            }\\n            return false;\\n        }\\n        \\n        function hidePWAInstallButton() {\\n            const pwaInstallButton = document.querySelector(\'.pwa-install-fixed\');\\n            if (pwaInstallButton) {\\n                if (isOnAppPage() || isPWAInstalled()) {\\n                    console.log(\'Hiding PWA install button - on App page or PWA installed\');\\n                    pwaInstallButton.style.display = \'none\';\\n                } else {\\n                    pwaInstallButton.style.display = \'\';\\n                }\\n            }\\n        }\\n        \\n        function installPWA() {\\n            console.log(\'installPWA called\');\\n            // Hide banner v√† dismiss\\n            const pwaBanner = document.getElementById(\'pwa-install-banner\');\\n            if (pwaBanner) {\\n                pwaBanner.style.display = \'none\';\\n            }\\n            localStorage.setItem(\'pwa-banner-dismissed\', \'true\');\\n            // Detect platform\\n            const isAndroid = /Android/.test(navigator.userAgent);\\n            const isIOS = /iPhone|iPad|iPod/.test(navigator.userAgent);\\n            if (isAndroid) {\\n                // Android: Redirect to GitHub Pages App ƒë·ªÉ c√†i ƒë·∫∑t\\n                window.location.href = \'https://nguenvanky.github.io/App/\';\\n            } else if (isIOS) {\\n                // iOS: Hi·ªÉn th·ªã h∆∞·ªõng d·∫´n c√†i ƒë·∫∑t tr·ª±c ti·∫øp t·ª´ trang hi·ªán t·∫°i (kh√¥ng redirect)\\n                const instructions = \\n                    \'üì± H∆∞·ªõng d·∫´n c√†i ƒë·∫∑t tr√™n iPhone/iPad:\\n\\n\' +\\n                    \'1. Nh·∫•n n√∫t Share (m≈©i t√™n l√™n ‚¨ÜÔ∏è) ·ªü thanh ƒë·ªãa ch·ªâ Safari\\n\' +\\n                    \'2. Cu·ªôn xu·ªëng v√† ch·ªçn \"Th√™m v√†o M√†n h√¨nh ch√≠nh\" ho·∫∑c \"Add to Home Screen\"\\n\' +\\n                    \'3. Nh·∫•n \"Th√™m\" ho·∫∑c \"Add\" ·ªü g√≥c ph·∫£i tr√™n\\n\' +\\n                    \'4. ·ª®ng d·ª•ng s·∫Ω xu·∫•t hi·ªán tr√™n m√†n h√¨nh ch√≠nh c·ªßa b·∫°n\\n\\n\' +\\n                    \'üí° ·ª®ng d·ª•ng s·∫Ω l∆∞u tr·ª±c ti·∫øp trang Settings ho·∫∑c Otto Control n√†y, kh√¥ng c·∫ßn qua GitHub Pages.\';\\n                alert(instructions);\\n            } else {\\n                // Desktop ho·∫∑c browser kh√°c: Redirect ƒë·∫øn GitHub Pages App\\n                window.location.href = \'https://nguenvanky.github.io/App/\';\\n            }\\n        }\\n        \\n        // Hide button immediately if on GitHub Pages App page\\n        hidePWAInstallButton();\\n        \\n        // Language translations for Web Settings\\n        const settingsTranslations = {\\n            \'zh-CN\': {\\n                \'settings.title\': \'‚öôÔ∏è Â∞èÊô∫ËÆæÁΩÆ\'\\n            },\\n            \'zh-TW\': {\\n                \'settings.title\': \'‚öôÔ∏è Â∞èÊô∫Ë®≠ÂÆö\'\\n            },\\n            \'en-US\': {\\n                \'settings.title\': \'‚öôÔ∏è Xiaozhi Settings\'\\n            },\\n            \'vi-VN\': {\\n                \'settings.title\': \'‚öôÔ∏è C√†i ƒê·∫∑t Xiaozhi\'\\n            }\\n        };\\n        \\n        // Get saved language or detect browser language\\n        function getCurrentLanguage() {\\n            const saved = localStorage.getItem(\'web_settings_language\');\\n            if (saved && settingsTranslations[saved]) return saved;\\n            const browserLang = navigator.language || navigator.userLanguage;\\n            if (browserLang.startsWith(\'zh\')) {\\n                return browserLang === \'zh-TW\' || browserLang === \'zh-Hant\' ? \'zh-TW\' : \'zh-CN\';\\n            }\\n            if (settingsTranslations[browserLang]) return browserLang;\\n            return \'en-US\'; // Default\\n        }\\n        \\n        // Change language\\n        function changeLanguage(lang) {\\n            localStorage.setItem(\'web_settings_language\', lang);\\n            updateTranslations(lang);\\n        }\\n        \\n        // Update translations\\n        function updateTranslations(lang) {\\n            const t = settingsTranslations[lang] || settingsTranslations[\'en-US\'];\\n            document.querySelectorAll(\'[data-i18n]\').forEach(el => {\\n                const key = el.getAttribute(\'data-i18n\');\\n                if (t[key]) {\\n                    if (el.tagName === \'INPUT\' || el.tagName === \'TEXTAREA\') {\\n                        el.placeholder = t[key];\\n                    } else {\\n                        el.textContent = t[key];\\n                    }\\n                }\\n            });\\n            const langSelect = document.getElementById(\'language\');\\n            if (langSelect) {\\n                langSelect.value = lang;\\n            }\\n        }\\n        \\n        // Initialize language on page load\\n        const currentLang = getCurrentLanguage();\\n        updateTranslations(currentLang);\\n        \\n        // QR Code Management\\n        let qrCodes = [];\\n        let portalMusicServers = [];\\n        let portalConfig = null;\\n        let portalMusicStatusEl = null;\\n        let portalMusicListEl = null;\\n        let deviceMacAddress = null;\\n        let portalMusicFetchRequested = false;\\n        let portalRadioChannels = [];\\n        let portalRadioStatusEl = null;\\n        let portalRadioListEl = null;\\n        let portalRadioFetchRequested = false;\\n        let portalFirmwareList = [];\\n        let portalOtaStatusEl = null;\\n        let portalOtaListEl = null;\\n        let portalOtaFetchRequested = false;\\n        let portalAssetsList = [];\\n        let portalAssetsStatusEl = null;\\n        let portalAssetsListEl = null;\\n        let portalAssetsFetchRequested = false;\\n        const MAX_QR_CODES = 10;\\n        \\n        async function loadQrSettings() {\\n            try {\\n                const res = await fetch(\'/api/qr/settings\');\\n                \\n                // Check if response is OK\\n                if (!res.ok) {\\n                    console.error(\'Failed to load QR settings, status:\', res.status);\\n                    // Use default values if failed\\n                    document.getElementById(\'qr_duration\').value = 40;\\n                    qrCodes = [];\\n                    renderQrCodesList();\\n                    return;\\n                }\\n                \\n                // Parse JSON response\\n                let data;\\n                try {\\n                    const text = await res.text();\\n                    data = JSON.parse(text);\\n                } catch (parseError) {\\n                    console.error(\'Failed to parse JSON response:\', parseError);\\n                    // Use default values if parsing failed\\n                    document.getElementById(\'qr_duration\').value = 40;\\n                    qrCodes = [];\\n                    renderQrCodesList();\\n                    return;\\n                }\\n                \\n                if (data.success) {\\n                    document.getElementById(\'qr_duration\').value = data.duration || 40;\\n                    qrCodes = data.qr_codes || [];\\n                    renderQrCodesList();\\n                }\\n            } catch (e) {\\n                console.error(\'Error loading QR settings:\', e);\\n                // Use default values on error\\n                document.getElementById(\'qr_duration\').value = 40;\\n                qrCodes = [];\\n                renderQrCodesList();\\n            }\\n        }\\n        \\n        function renderQrCodesList() {\\n            const listDiv = document.getElementById(\'qr-codes-list\');\\n            listDiv.innerHTML = \'\';\\n            \\n            if (qrCodes.length === 0) {\\n                listDiv.innerHTML = \'<p style=\"color: #666; font-style: italic;\">No QR codes yet. Add your first QR code!</p>\';\\n                return;\\n            }\\n            \\n            qrCodes.forEach((qr, index) => {\\n                const qrDiv = document.createElement(\'div\');\\n                qrDiv.style.cssText = \'border: 1px solid #ddd; padding: 10px; margin: 5px 0; border-radius: 4px; background: #f9f9f9;\';\\n                qrDiv.innerHTML = `\\n                    <div style=\"display: flex; justify-content: space-between; align-items: start;\">\\n                        <div style=\"flex: 1;\">\\n                            <strong>${escapeHtml(qr.name)}</strong>\\n                            <div style=\"font-size: 12px; color: #666; margin-top: 5px; word-break: break-all;\">\\n                                ${escapeHtml(qr.data.substring(0, 80))}${qr.data.length > 80 ? \'...\' : \'\'}\\n                            </div>\\n                        </div>\\n                        <div>\\n                            <button onclick=\"displayQrCode(${index})\" style=\"padding: 5px 10px; margin: 0 2px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer;\">üì∫ Show</button>\\n                            <button onclick=\"editQrCode(${index})\" style=\"padding: 5px 10px; margin: 0 2px; background: #28a745; color: white; border: none; border-radius: 3px; cursor: pointer;\">‚úèÔ∏è Edit</button>\\n                            <button onclick=\"deleteQrCode(${index})\" style=\"padding: 5px 10px; margin: 0 2px; background: #dc3545; color: white; border: none; border-radius: 3px; cursor: pointer;\">üóëÔ∏è Delete</button>\\n                        </div>\\n                    </div>\\n                `;\\n                listDiv.appendChild(qrDiv);\\n            });\\n        }\\n        \\n        function showAddQrCode() {\\n            document.getElementById(\'add-qr-form\').style.display = \'block\';\\n            document.getElementById(\'new_qr_name\').value = \'\';\\n            document.getElementById(\'new_qr_data\').value = \'\';\\n        }\\n        \\n        function hideAddQrCode() {\\n            document.getElementById(\'add-qr-form\').style.display = \'none\';\\n        }\\n        \\n        function addQrCode() {\\n            const name = document.getElementById(\'new_qr_name\').value.trim();\\n            const data = document.getElementById(\'new_qr_data\').value.trim();\\n            \\n            if (!name || !data) {\\n                alert(\'Please enter both name and QR data\');\\n                return;\\n            }\\n            \\n            if (qrCodes.length >= MAX_QR_CODES) {\\n                alert(`Maximum ${MAX_QR_CODES} QR codes allowed`);\\n                return;\\n            }\\n            \\n            qrCodes.push({ id: Date.now().toString(), name: name, data: data });\\n            renderQrCodesList();\\n            hideAddQrCode();\\n        }\\n        \\n        function editQrCode(index) {\\n            const qr = qrCodes[index];\\n            document.getElementById(\'new_qr_name\').value = qr.name;\\n            document.getElementById(\'new_qr_data\').value = qr.data;\\n            document.getElementById(\'add-qr-form\').style.display = \'block\';\\n            \\n            // Replace add with update\\n            const addBtn = document.querySelector(\'#add-qr-form button[onclick=\"addQrCode()\"]\');\\n            addBtn.textContent = \'Update\';\\n            addBtn.onclick = function() {\\n                updateQrCode(index);\\n            };\\n        }\\n        \\n        function updateQrCode(index) {\\n            const name = document.getElementById(\'new_qr_name\').value.trim();\\n            const data = document.getElementById(\'new_qr_data\').value.trim();\\n            \\n            if (!name || !data) {\\n                alert(\'Please enter both name and QR data\');\\n                return;\\n            }\\n            \\n            qrCodes[index].name = name;\\n            qrCodes[index].data = data;\\n            renderQrCodesList();\\n            hideAddQrCode();\\n            \\n            // Restore add button\\n            const addBtn = document.querySelector(\'#add-qr-form button[onclick*=\"QrCode\"]\');\\n            addBtn.textContent = \'Add\';\\n            addBtn.onclick = addQrCode;\\n        }\\n        \\n        function deleteQrCode(index) {\\n            if (confirm(\'Delete this QR code?\')) {\\n                qrCodes.splice(index, 1);\\n                renderQrCodesList();\\n            }\\n        }\\n        \\n        async function displayQrCode(index) {\\n            const qr = qrCodes[index];\\n            try {\\n                const res = await fetch(\'/api/qr/display\', {\\n                    method: \'POST\',\\n                    headers: {\'Content-Type\': \'application/json\'},\\n                    body: JSON.stringify({ qr_data: qr.data })\\n                });\\n                \\n                // Check if response is OK\\n                if (!res.ok) {\\n                    const text = await res.text();\\n                    alert(\'Failed to display QR code, status: \' + res.status + \' - \' + text);\\n                    return;\\n                }\\n                \\n                // Parse JSON response\\n                let data;\\n                try {\\n                    const text = await res.text();\\n                    data = JSON.parse(text);\\n                } catch (parseError) {\\n                    console.error(\'Failed to parse JSON response:\', parseError);\\n                    alert(\'Failed to parse server response\');\\n                    return;\\n                }\\n                \\n                if (data.success) {\\n                    alert(\'QR code displayed on LCD!\');\\n                } else {\\n                    alert(\'Failed: \' + (data.error || \'Unknown error\'));\\n                }\\n            } catch (e) {\\n                console.error(\'Error displaying QR code:\', e);\\n                alert(\'Error: \' + e.message);\\n            }\\n        }\\n        \\n        async function saveQrSettings() {\\n            const duration = parseInt(document.getElementById(\'qr_duration\').value);\\n            if (duration < 10 || duration > 120) {\\n                alert(\'Duration must be between 10 and 120 seconds\');\\n                return;\\n            }\\n            \\n            try {\\n                const res = await fetch(\'/api/qr/settings\', {\\n                    method: \'POST\',\\n                    headers: {\'Content-Type\': \'application/json\'},\\n                    body: JSON.stringify({\\n                        duration: duration,\\n                        qr_codes: qrCodes\\n                    })\\n                });\\n                \\n                // Check if response is OK\\n                if (!res.ok) {\\n                    const text = await res.text();\\n                    showStatus(\'Failed to save QR settings, status: \' + res.status + \' - \' + text, true);\\n                    return;\\n                }\\n                \\n                // Parse JSON response\\n                let data;\\n                try {\\n                    const text = await res.text();\\n                    data = JSON.parse(text);\\n                } catch (parseError) {\\n                    console.error(\'Failed to parse JSON response:\', parseError);\\n                    showStatus(\'Failed to parse server response\', true);\\n                    return;\\n                }\\n                \\n                if (data.success) {\\n                    showStatus(\'QR settings saved!\', false);\\n                } else {\\n                    showStatus(\'Failed: \' + (data.error || \'Unknown error\'), true);\\n                }\\n            } catch (e) {\\n                console.error(\'Error saving QR settings:\', e);\\n                showStatus(\'Error: \' + e.message, true);\\n            }\\n        }\\n\\n        function ensurePortalElements() {\\n            if (!portalMusicStatusEl) {\\n                portalMusicStatusEl = document.getElementById(\'portal-music-status\');\\n            }\\n            if (!portalMusicListEl) {\\n                portalMusicListEl = document.getElementById(\'portal-music-list\');\\n            }\\n            return portalMusicStatusEl !== null && portalMusicListEl !== null;\\n        }\\n\\n        function setPortalMusicStatus(message, isError = false) {\\n            if (!ensurePortalElements()) return;\\n            portalMusicStatusEl.textContent = message;\\n            if (isError) {\\n                portalMusicStatusEl.classList.add(\'error\');\\n            } else {\\n                portalMusicStatusEl.classList.remove(\'error\');\\n            }\\n        }\\n\\n        function renderPortalMusicServers(servers) {\\n            if (!ensurePortalElements()) return;\\n            portalMusicListEl.innerHTML = \'\';\\n            servers.forEach(server => {\\n                const endpoint = server.endpoint || server.url || server.api || \'\';\\n                if (!endpoint) {\\n                    return;\\n                }\\n                const item = document.createElement(\'div\');\\n                item.className = \'portal-music-item\';\\n\\n                const meta = document.createElement(\'div\');\\n                meta.className = \'portal-music-meta\';\\n\\n                const name = document.createElement(\'strong\');\\n                name.textContent = server.name || server.title || \'M√°y ch·ªß kh√¥ng t√™n\';\\n                meta.appendChild(name);\\n\\n                const detail = document.createElement(\'span\');\\n                const region = server.region ? `‚Ä¢ ${server.region}` : \'\';\\n                const priority = typeof server.priority === \'number\' ? `‚Ä¢ ∆Øu ti√™n ${server.priority}` : \'\';\\n                detail.textContent = `${server.status === \'online\' ? \'üü¢ Online\' : \'‚ÑπÔ∏è\' } ${region} ${priority}`.trim();\\n                meta.appendChild(detail);\\n\\n                const urlLine = document.createElement(\'span\');\\n                urlLine.style.fontSize = \'12px\';\\n                urlLine.style.color = \'#4a5568\';\\n                urlLine.textContent = endpoint;\\n                meta.appendChild(urlLine);\\n\\n                const btn = document.createElement(\'button\');\\n                btn.className = \'portal-music-select\';\\n                btn.textContent = \'Ch·ªçn m√°y ch·ªß\';\\n                btn.onclick = function() {\\n                    selectPortalMusicServer(endpoint, server.name || server.title || \'\');\\n                };\\n\\n                item.appendChild(meta);\\n                item.appendChild(btn);\\n\\n                portalMusicListEl.appendChild(item);\\n            });\\n        }\\n\\n        function selectPortalMusicServer(endpoint, label) {\\n            const input = document.getElementById(\'music_server_url\');\\n            if (input) {\\n                input.value = endpoint;\\n                input.focus();\\n            }\\n            showStatus(`ƒê√£ ch·ªçn m√°y ch·ªß: ${label || endpoint}`, false);\\n        }\\n        \\n        let vs=false;\\n        async function checkVipStatus(){try{const r=await fetch(\'/api/vip/check\');if(!r.ok)return;const d=await r.json();vs=d.vip_status||false;const vc=d.vip_checked||false;updateVipLinks();if(!vc&&portalConfig?.portal_base_url&&deviceMacAddress){setTimeout(()=>checkVipFromPortal(),500);}}catch(e){}}\\n        async function checkVipFromPortal(){if(!portalConfig?.portal_base_url||!deviceMacAddress){return;}try{const url=portalConfig.portal_base_url+\'index.php?api=check_vip&token=\'+encodeURIComponent(deviceMacAddress);const r=await fetch(url);if(!r.ok){return;}const txt=await r.text();let d;try{d=JSON.parse(txt);}catch(e){return;}const isVip=d.is_vip===true;await updateVipStatus(isVip);}catch(e){}}\\n        async function updateVipStatus(v){try{const r=await fetch(\'/api/vip/update\',{method:\'POST\',headers:{\'Content-Type\':\'application/json\'},body:JSON.stringify({vip_status:v})});if(!r.ok)return;const d=await r.json();vs=d.vip_status||false;updateVipLinks();}catch(e){}}\\n        function updateVipLinks(){const ol=document.querySelector(\'a[href=\"/otto\"]\'),sl=document.querySelector(\'a[href=\"/servo-calibration\"]\');const s=vs?\'1\':\'0.5\',p=vs?\'auto\':\'none\',c=vs?\'pointer\':\'not-allowed\';if(ol){ol.style.opacity=s;ol.style.pointerEvents=p;ol.style.cursor=c;if(!vs)ol.title=\'VIP Required\';}if(sl){sl.style.opacity=s;sl.style.pointerEvents=p;sl.style.cursor=c;if(!vs)sl.title=\'VIP Required\';}}\\n\\n        async function fetchPortalConfig() {\\n            if (!ensurePortalElements()) return;\\n            try {\\n                const res = await fetch(\'/portal-config.json\');\\n                if (!res.ok) {\\n                    throw new Error(\'HTTP \' + res.status);\\n                }\\n                portalConfig = await res.json();\\n                vs = portalConfig.vip_status || false;\\n                const vc = portalConfig.vip_checked || false;\\n                updateVipLinks();\\n                if (!vc && deviceMacAddress) setTimeout(()=>checkVipFromPortal(),1000);\\n                setPortalMusicStatus(\'üîê ƒêang x√°c minh thi·∫øt b·ªã v·ªõi h·ªá th·ªëng qu·∫£n l√Ω...\');\\n                tryFetchPortalMusicServers(true);\\n                // Also load radio channels if elements are available\\n                if (ensureRadioPortalElements()) {\\n                    setPortalRadioStatus(\'üîê ƒêang x√°c minh thi·∫øt b·ªã v·ªõi h·ªá th·ªëng qu·∫£n l√Ω...\');\\n                    tryFetchPortalRadioChannels(true);\\n                }\\n                // Also load firmware list if elements are available\\n                if (ensureOtaPortalElements()) {\\n                    setPortalOtaStatus(\'üîê ƒêang x√°c minh thi·∫øt b·ªã v·ªõi h·ªá th·ªëng qu·∫£n l√Ω...\');\\n                    tryFetchPortalFirmwareList(true);\\n                }\\n                // Also load assets list if elements are available\\n                if (ensureAssetsPortalElements()) {\\n                    setPortalAssetsStatus(\'üîê ƒêang x√°c minh thi·∫øt b·ªã v·ªõi h·ªá th·ªëng qu·∫£n l√Ω...\');\\n                    tryFetchPortalAssetsList(true);\\n                }\\n            } catch (error) {\\n                console.error(\'Portal config error\', error);\\n                setPortalMusicStatus(\'Kh√¥ng th·ªÉ t·∫£i c·∫•u h√¨nh portal. Vui l√≤ng ki·ªÉm tra l·∫°i.\', true);\\n                if (ensureRadioPortalElements()) {\\n                    setPortalRadioStatus(\'Kh√¥ng th·ªÉ t·∫£i c·∫•u h√¨nh portal. Vui l√≤ng ki·ªÉm tra l·∫°i.\', true);\\n                }\\n                if (ensureOtaPortalElements()) {\\n                    setPortalOtaStatus(\'Kh√¥ng th·ªÉ t·∫£i c·∫•u h√¨nh portal. Vui l√≤ng ki·ªÉm tra l·∫°i.\', true);\\n                }\\n                if (ensureAssetsPortalElements()) {\\n                    setPortalAssetsStatus(\'Kh√¥ng th·ªÉ t·∫£i c·∫•u h√¨nh portal. Vui l√≤ng ki·ªÉm tra l·∫°i.\', true);\\n                }\\n            }\\n        }\\n\\n        async function tryFetchPortalMusicServers(force = false) {\\n            if (!ensurePortalElements()) return;\\n            if (!portalConfig || !deviceMacAddress) return;\\n            if (portalMusicFetchRequested && !force) return;\\n            portalMusicFetchRequested = true;\\n            await loadPortalMusicServers();\\n        }\\n\\n        function buildPortalMusicEndpoint() {\\n            if (!portalConfig) return null;\\n            const base = portalConfig.music_servers_endpoint || (portalConfig.portal_base_url ? portalConfig.portal_base_url + \'index.php?api=music_servers\' : null);\\n            if (!base) return null;\\n            const separator = base.includes(\'?\') ? \'&\' : \'?\';\\n            return `${base}${separator}token=${encodeURIComponent(deviceMacAddress)}`;\\n        }\\n\\n        async function loadPortalMusicServers() {\\n            if (!ensurePortalElements()) return;\\n            const endpoint = buildPortalMusicEndpoint();\\n            if (!endpoint) {\\n                setPortalMusicStatus(\'Thi·∫øu c·∫•u h√¨nh endpoint m√°y ch·ªß nh·∫°c.\', true);\\n                return;\\n            }\\n            setPortalMusicStatus(\'üîÑ ƒêang t·∫£i danh s√°ch m√°y ch·ªß VIP t·ª´ portal...\');\\n            try {\\n                const response = await fetch(endpoint);\\n                if (!response.ok) {\\n                    throw new Error(\'HTTP \' + response.status);\\n                }\\n                const data = await response.json();\\n                if (data.vip_required) {\\n                    setPortalMusicStatus(\'Thi·∫øt b·ªã ch∆∞a ƒë∆∞·ª£c k√≠ch ho·∫°t VIP. Vui l√≤ng ƒëƒÉng k√Ω tr√™n portal.\', true);\\n                    portalMusicListEl.innerHTML = \'\';\\n                    return;\\n                }\\n                const servers = Array.isArray(data.servers) ? data.servers : (Array.isArray(data.list) ? data.list : []);\\n                if (!servers.length) {\\n                    setPortalMusicStatus(\'Kh√¥ng t√¨m th·∫•y m√°y ch·ªß VIP n√†o cho thi·∫øt b·ªã n√†y.\', true);\\n                    portalMusicListEl.innerHTML = \'\';\\n                    return;\\n                }\\n                portalMusicServers = servers;\\n                renderPortalMusicServers(servers);\\n                setPortalMusicStatus(\'Ch·ªçn m·ªôt m√°y ch·ªß VIP b√™n d∆∞·ªõi ƒë·ªÉ √°p d·ª•ng nhanh.\');\\n            } catch (error) {\\n                console.error(\'Portal music fetch error\', error);\\n                setPortalMusicStatus(\'Kh√¥ng th·ªÉ k·∫øt n·ªëi portal. Ki·ªÉm tra m·∫°ng ho·∫∑c tr·∫°ng th√°i VIP.\', true);\\n                portalMusicListEl.innerHTML = \'\';\\n            }\\n        }\\n\\n        function initPortalMusicSection() {\\n            if (!ensurePortalElements()) return;\\n            fetchPortalConfig();\\n        }\\n\\n        if (document.readyState === \'loading\') {\\n            document.addEventListener(\'DOMContentLoaded\', initPortalMusicSection);\\n        } else {\\n            initPortalMusicSection();\\n        }\\n\\n        // Radio Channels Portal Functions\\n        function ensureRadioPortalElements() {\\n            if (!portalRadioStatusEl) {\\n                portalRadioStatusEl = document.getElementById(\'portal-radio-status\');\\n            }\\n            if (!portalRadioListEl) {\\n                portalRadioListEl = document.getElementById(\'portal-radio-list\');\\n            }\\n            return portalRadioStatusEl !== null && portalRadioListEl !== null;\\n        }\\n\\n        function setPortalRadioStatus(message, isError = false) {\\n            if (!ensureRadioPortalElements()) return;\\n            portalRadioStatusEl.textContent = message;\\n            if (isError) {\\n                portalRadioStatusEl.classList.add(\'error\');\\n            } else {\\n                portalRadioStatusEl.classList.remove(\'error\');\\n            }\\n        }\\n\\n        function renderPortalRadioChannels(channels) {\\n            if (!ensureRadioPortalElements()) return;\\n            portalRadioListEl.innerHTML = \'\';\\n            channels.forEach(channel => {\\n                const url = channel.url || channel.stream_url || \'\';\\n                const title = channel.title || channel.name || \'K√™nh kh√¥ng t√™n\';\\n                const artist = channel.artist || \'\';\\n                if (!url) {\\n                    return;\\n                }\\n                const item = document.createElement(\'div\');\\n                item.className = \'portal-radio-item\';\\n\\n                const meta = document.createElement(\'div\');\\n                meta.className = \'portal-radio-meta\';\\n\\n                const name = document.createElement(\'strong\');\\n                name.textContent = title;\\n                meta.appendChild(name);\\n\\n                const detail = document.createElement(\'span\');\\n                const genre = channel.genre ? `‚Ä¢ ${channel.genre}` : \'\';\\n                const language = channel.language ? `‚Ä¢ ${channel.language.toUpperCase()}` : \'\';\\n                const status = channel.status === \'online\' ? \'üü¢ Online\' : \'‚ÑπÔ∏è\';\\n                detail.textContent = `${status} ${genre} ${language}`.trim();\\n                meta.appendChild(detail);\\n\\n                const urlLine = document.createElement(\'span\');\\n                urlLine.style.fontSize = \'12px\';\\n                urlLine.style.color = \'#4a5568\';\\n                urlLine.textContent = url;\\n                meta.appendChild(urlLine);\\n\\n                const btn = document.createElement(\'button\');\\n                btn.className = \'portal-radio-select\';\\n                btn.textContent = \'Th√™m k√™nh\';\\n                btn.onclick = function() {\\n                    selectPortalRadioChannel(title, url, artist);\\n                };\\n\\n                item.appendChild(meta);\\n                item.appendChild(btn);\\n\\n                portalRadioListEl.appendChild(item);\\n            });\\n        }\\n\\n        function selectPortalRadioChannel(title, url, artist) {\\n            document.getElementById(\'new_radio_title\').value = title;\\n            document.getElementById(\'new_radio_url\').value = url;\\n            document.getElementById(\'new_radio_artist\').value = artist || \'\';\\n            document.getElementById(\'add-radio-form\').style.display = \'block\';\\n            showStatus(`ƒê√£ ch·ªçn k√™nh: ${title}`, false);\\n        }\\n\\n        function buildPortalRadioEndpoint() {\\n            if (!portalConfig) return null;\\n            const base = portalConfig.radio_channels_endpoint || (portalConfig.portal_base_url ? portalConfig.portal_base_url + \'index.php?api=radio_channels\' : null);\\n            if (!base) return null;\\n            const separator = base.includes(\'?\') ? \'&\' : \'?\';\\n            return `${base}${separator}token=${encodeURIComponent(deviceMacAddress)}&output=esp32`;\\n        }\\n\\n        async function loadPortalRadioChannels() {\\n            if (!ensureRadioPortalElements()) return;\\n            const endpoint = buildPortalRadioEndpoint();\\n            if (!endpoint) {\\n                setPortalRadioStatus(\'Thi·∫øu c·∫•u h√¨nh endpoint k√™nh radio.\', true);\\n                return;\\n            }\\n            setPortalRadioStatus(\'üîÑ ƒêang t·∫£i danh s√°ch k√™nh radio VIP t·ª´ portal...\');\\n            try {\\n                const response = await fetch(endpoint);\\n                if (!response.ok) {\\n                    throw new Error(\'HTTP \' + response.status);\\n                }\\n                const data = await response.json();\\n                let channels = [];\\n                if (Array.isArray(data)) {\\n                    channels = data;\\n                } else if (data.vip_required) {\\n                    setPortalRadioStatus(\'Thi·∫øt b·ªã ch∆∞a ƒë∆∞·ª£c k√≠ch ho·∫°t VIP. Vui l√≤ng ƒëƒÉng k√Ω tr√™n portal.\', true);\\n                    portalRadioListEl.innerHTML = \'\';\\n                    return;\\n                } else if (Array.isArray(data.channels)) {\\n                    channels = data.channels;\\n                } else if (Array.isArray(data.list)) {\\n                    channels = data.list;\\n                }\\n                if (!channels.length) {\\n                    setPortalRadioStatus(\'Kh√¥ng t√¨m th·∫•y k√™nh radio VIP n√†o cho thi·∫øt b·ªã n√†y.\', true);\\n                    portalRadioListEl.innerHTML = \'\';\\n                    return;\\n                }\\n                portalRadioChannels = channels;\\n                renderPortalRadioChannels(channels);\\n                setPortalRadioStatus(\'Ch·ªçn m·ªôt k√™nh radio VIP b√™n d∆∞·ªõi ƒë·ªÉ th√™m v√†o danh s√°ch.\');\\n            } catch (error) {\\n                console.error(\'Portal radio fetch error\', error);\\n                setPortalRadioStatus(\'Kh√¥ng th·ªÉ k·∫øt n·ªëi portal. Ki·ªÉm tra m·∫°ng ho·∫∑c tr·∫°ng th√°i VIP.\', true);\\n                portalRadioListEl.innerHTML = \'\';\\n            }\\n        }\\n\\n        async function tryFetchPortalRadioChannels(force = false) {\\n            if (!ensureRadioPortalElements()) return;\\n            if (!portalConfig || !deviceMacAddress) return;\\n            if (portalRadioFetchRequested && !force) return;\\n            portalRadioFetchRequested = true;\\n            await loadPortalRadioChannels();\\n        }\\n\\n        function initPortalRadioSection() {\\n            if (!ensureRadioPortalElements()) return;\\n            if (portalConfig && deviceMacAddress) {\\n                tryFetchPortalRadioChannels();\\n            } else {\\n                fetchPortalConfig().then(() => {\\n                    if (deviceMacAddress) {\\n                        tryFetchPortalRadioChannels();\\n                    }\\n                });\\n            }\\n        }\\n\\n        // Initialize Radio Portal when device info is loaded\\n        if (document.readyState === \'loading\') {\\n            document.addEventListener(\'DOMContentLoaded\', function() {\\n                setTimeout(initPortalRadioSection, 1000);\\n            });\\n        } else {\\n            setTimeout(initPortalRadioSection, 1000);\\n        }\\n\\n        // OTA Firmware Portal Functions\\n        function ensureOtaPortalElements() {\\n            if (!portalOtaStatusEl) {\\n                portalOtaStatusEl = document.getElementById(\'portal-ota-status\');\\n            }\\n            if (!portalOtaListEl) {\\n                portalOtaListEl = document.getElementById(\'portal-ota-list\');\\n            }\\n            return portalOtaStatusEl !== null && portalOtaListEl !== null;\\n        }\\n\\n        function setPortalOtaStatus(message, isError = false) {\\n            if (!ensureOtaPortalElements()) return;\\n            portalOtaStatusEl.textContent = message;\\n            if (isError) {\\n                portalOtaStatusEl.classList.add(\'error\');\\n            } else {\\n                portalOtaStatusEl.classList.remove(\'error\');\\n            }\\n        }\\n\\n        function renderPortalFirmwareList(firmwareList) {\\n            if (!ensureOtaPortalElements()) return;\\n            portalOtaListEl.innerHTML = \'\';\\n            firmwareList.forEach(firmware => {\\n                // API tr·∫£ v·ªÅ: file_url, version, release_date, file_size, release_notes, etc.\\n                const url = firmware.file_url || firmware.url || firmware.download_url || firmware.link || \'\';\\n                const version = firmware.version || firmware.name || \'Firmware kh√¥ng t√™n\';\\n                const description = firmware.release_notes || firmware.description || firmware.info || firmware.desc || \'\';\\n                const size = firmware.file_size || firmware.size || firmware.fileSize || 0;\\n                const sizeStr = size ? `(${formatBytes(size)})` : \'\';\\n                const releaseDate = firmware.release_date || firmware.releaseDate || \'\';\\n                const checksum = firmware.checksum_md5 || firmware.checksum_sha256 || firmware.checksum || \'\';\\n                if (!url) {\\n                    return;\\n                }\\n                const item = document.createElement(\'div\');\\n                item.className = \'portal-radio-item\';\\n\\n                const meta = document.createElement(\'div\');\\n                meta.className = \'portal-radio-meta\';\\n\\n                const name = document.createElement(\'strong\');\\n                name.textContent = version;\\n                if (sizeStr) {\\n                    name.textContent += \' \' + sizeStr;\\n                }\\n                meta.appendChild(name);\\n\\n                if (releaseDate) {\\n                    const dateSpan = document.createElement(\'span\');\\n                    dateSpan.style.fontSize = \'12px\';\\n                    dateSpan.style.color = \'#718096\';\\n                    dateSpan.textContent = ` (${releaseDate})`;\\n                    meta.appendChild(dateSpan);\\n                }\\n\\n                if (description) {\\n                    const detail = document.createElement(\'p\');\\n                    detail.style.margin = \'4px 0\';\\n                    detail.style.fontSize = \'13px\';\\n                    detail.textContent = description;\\n                    meta.appendChild(detail);\\n                }\\n\\n                if (checksum) {\\n                    const checksumSpan = document.createElement(\'span\');\\n                    checksumSpan.style.fontSize = \'11px\';\\n                    checksumSpan.style.color = \'#a0aec0\';\\n                    checksumSpan.textContent = `Checksum: ${checksum.substring(0, 16)}...`;\\n                    meta.appendChild(checksumSpan);\\n                }\\n\\n                const urlLine = document.createElement(\'span\');\\n                urlLine.style.fontSize = \'12px\';\\n                urlLine.style.color = \'#4a5568\';\\n                urlLine.textContent = url;\\n                meta.appendChild(urlLine);\\n\\n                const btn = document.createElement(\'button\');\\n                btn.className = \'portal-radio-select\';\\n                btn.textContent = \'Ch·ªçn firmware\';\\n                btn.onclick = function() {\\n                    selectPortalFirmware(url, version);\\n                };\\n\\n                item.appendChild(meta);\\n                item.appendChild(btn);\\n\\n                portalOtaListEl.appendChild(item);\\n            });\\n        }\\n\\n        function selectPortalFirmware(url, version) {\\n            document.getElementById(\'ota_firmware_url\').value = url;\\n            showStatus(`ƒê√£ ch·ªçn firmware: ${version}`, false);\\n        }\\n\\n        function formatBytes(bytes) {\\n            if (bytes === 0) return \'0 Bytes\';\\n            const k = 1024;\\n            const sizes = [\'Bytes\', \'KB\', \'MB\', \'GB\'];\\n            const i = Math.floor(Math.log(bytes) / Math.log(k));\\n            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + \' \' + sizes[i];\\n        }\\n\\n        function buildPortalFirmwareEndpoint() {\\n            if (!portalConfig) return null;\\n            const base = portalConfig.firmware_endpoint || (portalConfig.portal_base_url ? portalConfig.portal_base_url + \'index.php?api=firmware_list\' : null);\\n            if (!base) return null;\\n            const separator = base.includes(\'?\') ? \'&\' : \'?\';\\n            return `${base}${separator}token=${encodeURIComponent(deviceMacAddress)}&output=esp32`;\\n        }\\n\\n        async function loadPortalFirmwareList() {\\n            if (!ensureOtaPortalElements()) return;\\n            const endpoint = buildPortalFirmwareEndpoint();\\n            if (!endpoint) {\\n                setPortalOtaStatus(\'Thi·∫øu c·∫•u h√¨nh endpoint firmware.\', true);\\n                return;\\n            }\\n            setPortalOtaStatus(\'üîÑ ƒêang t·∫£i danh s√°ch firmware VIP t·ª´ portal...\');\\n            try {\\n                const response = await fetch(endpoint);\\n                if (!response.ok) {\\n                    const errorText = await response.text();\\n                    console.error(\'Portal firmware fetch HTTP error:\', response.status, errorText);\\n                    if (response.status === 403) {\\n                        setPortalOtaStatus(\'Thi·∫øt b·ªã ch∆∞a ƒë∆∞·ª£c k√≠ch ho·∫°t VIP ho·∫∑c kh√¥ng c√≥ quy·ªÅn truy c·∫≠p.\', true);\\n                    } else {\\n                        setPortalOtaStatus(\'L·ªói khi t·∫£i danh s√°ch firmware: HTTP \' + response.status, true);\\n                    }\\n                    portalOtaListEl.innerHTML = \'\';\\n                    return;\\n                }\\n                const textResponse = await response.text();\\n                let data;\\n                try {\\n                    data = JSON.parse(textResponse);\\n                } catch (jsonError) {\\n                    console.error(\'Failed to parse JSON from portal firmware list:\', jsonError, \'Response:\', textResponse.substring(0, 200));\\n                    setPortalOtaStatus(\'L·ªói ƒë·ªãnh d·∫°ng d·ªØ li·ªáu t·ª´ portal. Ki·ªÉm tra l·∫°i API.\', true);\\n                    portalOtaListEl.innerHTML = \'\';\\n                    return;\\n                }\\n                \\n                let firmwareList = [];\\n                if (Array.isArray(data)) {\\n                    firmwareList = data;\\n                } else if (data.vip_required) {\\n                    setPortalOtaStatus(\'Thi·∫øt b·ªã ch∆∞a ƒë∆∞·ª£c k√≠ch ho·∫°t VIP. Vui l√≤ng ƒëƒÉng k√Ω tr√™n portal.\', true);\\n                    portalOtaListEl.innerHTML = \'\';\\n                    return;\\n                } else if (data.error) {\\n                    setPortalOtaStatus(\'L·ªói t·ª´ portal: \' + data.error, true);\\n                    portalOtaListEl.innerHTML = \'\';\\n                    return;\\n                } else if (Array.isArray(data.firmware)) {\\n                    firmwareList = data.firmware;\\n                } else if (Array.isArray(data.list)) {\\n                    firmwareList = data.list;\\n                } else if (data.data && Array.isArray(data.data)) {\\n                    firmwareList = data.data;\\n                }\\n                \\n                if (!firmwareList.length) {\\n                    setPortalOtaStatus(\'Kh√¥ng t√¨m th·∫•y firmware n√†o cho thi·∫øt b·ªã n√†y. Ki·ªÉm tra l·∫°i tr·∫°ng th√°i VIP ho·∫∑c tham s·ªë API.\', true);\\n                    portalOtaListEl.innerHTML = \'\';\\n                    return;\\n                }\\n                portalFirmwareList = firmwareList;\\n                renderPortalFirmwareList(firmwareList);\\n                setPortalOtaStatus(\'Ch·ªçn m·ªôt firmware VIP b√™n d∆∞·ªõi ƒë·ªÉ n√¢ng c·∫•p.\');\\n            } catch (error) {\\n                console.error(\'Portal firmware fetch error\', error);\\n                setPortalOtaStatus(\'Kh√¥ng th·ªÉ k·∫øt n·ªëi portal. Ki·ªÉm tra m·∫°ng ho·∫∑c tr·∫°ng th√°i VIP. Error: \' + error.message, true);\\n                portalOtaListEl.innerHTML = \'\';\\n            }\\n        }\\n\\n        async function tryFetchPortalFirmwareList(force = false) {\\n            if (!ensureOtaPortalElements()) return;\\n            if (!portalConfig || !deviceMacAddress) return;\\n            if (portalOtaFetchRequested && !force) return;\\n            portalOtaFetchRequested = true;\\n            await loadPortalFirmwareList();\\n        }\\n\\n        function initPortalOtaSection() {\\n            if (!ensureOtaPortalElements()) return;\\n            if (portalConfig && deviceMacAddress) {\\n                tryFetchPortalFirmwareList();\\n            } else {\\n                fetchPortalConfig().then(() => {\\n                    if (deviceMacAddress) {\\n                        tryFetchPortalFirmwareList();\\n                    }\\n                });\\n            }\\n        }\\n\\n        // Initialize OTA Portal when device info is loaded\\n        if (document.readyState === \'loading\') {\\n            document.addEventListener(\'DOMContentLoaded\', function() {\\n                setTimeout(initPortalOtaSection, 1500);\\n            });\\n        } else {\\n            setTimeout(initPortalOtaSection, 1500);\\n        }\\n\\n        // Assets Portal Functions\\n        function ensureAssetsPortalElements() {\\n            if (!portalAssetsStatusEl) {\\n                portalAssetsStatusEl = document.getElementById(\'portal-assets-status\');\\n            }\\n            if (!portalAssetsListEl) {\\n                portalAssetsListEl = document.getElementById(\'portal-assets-list\');\\n            }\\n            return portalAssetsStatusEl !== null && portalAssetsListEl !== null;\\n        }\\n\\n        function setPortalAssetsStatus(message, isError = false) {\\n            if (!ensureAssetsPortalElements()) return;\\n            portalAssetsStatusEl.textContent = message;\\n            if (isError) {\\n                portalAssetsStatusEl.classList.add(\'error\');\\n            } else {\\n                portalAssetsStatusEl.classList.remove(\'error\');\\n            }\\n        }\\n\\n        function renderPortalAssetsList(l){if(!ensureAssetsPortalElements()||!l||l.length===0)return;portalAssetsListEl.innerHTML=\'\';for(let i=0;i<l.length;i++){const a=l[i];const u=a.file_url||a.url||a.download_url||a.link||\'\';if(!u)continue;const n=a.name||a.title||\'Assets kh√¥ng t√™n\';const v=a.version||\'\';const t=a.type||\'\';const d=a.description||a.info||a.desc||\'\';const s=a.file_size?`(${formatBytes(a.file_size)})`:\'\';const p=a.preview_image_url||a.preview||\'\';const it=document.createElement(\'div\');it.className=\'portal-radio-item\';if(p){const ic=document.createElement(\'div\');ic.style.cssText=\'width:80px;height:80px;flex-shrink:0;margin-right:12px;border-radius:6px;overflow:hidden;border:1px solid #e2e8f0\';const im=document.createElement(\'img\');im.src=p;im.style.cssText=\'width:100%;height:100%;object-fit:cover\';im.onerror=function(){ic.style.display=\'none\';};ic.appendChild(im);it.appendChild(ic);}const m=document.createElement(\'div\');m.className=\'portal-radio-meta\';m.style.flex=\'1\';const ne=document.createElement(\'strong\');ne.textContent=(t?`[${t.toUpperCase()}] `:\'\')+n+(v?` v${v}`:\'\');m.appendChild(ne);if(d||s){const dt=document.createElement(\'span\');dt.textContent=(d+\' \'+s).trim();m.appendChild(dt);}const ul=document.createElement(\'span\');ul.style.fontSize=\'12px\';ul.style.color=\'#4a5568\';ul.textContent=u;m.appendChild(ul);const b=document.createElement(\'button\');b.className=\'portal-radio-select\';b.textContent=\'Ch·ªçn assets\';b.onclick=function(){selectPortalAssets(u,n);};it.appendChild(m);it.appendChild(b);portalAssetsListEl.appendChild(it);}}\\n\\n        function selectPortalAssets(url, version) {\\n            document.getElementById(\'assets_url\').value = url;\\n            showStatus(`ƒê√£ ch·ªçn assets: ${version}`, false);\\n        }\\n\\n        function buildPortalAssetsEndpoint() {\\n            if (!portalConfig) return null;\\n            const base = portalConfig.assets_endpoint || (portalConfig.portal_base_url ? portalConfig.portal_base_url + \'index.php?api=assets\' : null);\\n            if (!base) return null;\\n            const separator = base.includes(\'?\') ? \'&\' : \'?\';\\n            return `${base}${separator}token=${encodeURIComponent(deviceMacAddress)}&output=esp32`;\\n        }\\n\\n        async function loadPortalAssetsList() {\\n            if (!ensureAssetsPortalElements()) return;\\n            const endpoint = buildPortalAssetsEndpoint();\\n            if (!endpoint) {\\n                setPortalAssetsStatus(\'Thi·∫øu c·∫•u h√¨nh endpoint assets.\', true);\\n                return;\\n            }\\n            setPortalAssetsStatus(\'üîÑ ƒêang t·∫£i danh s√°ch assets VIP t·ª´ portal...\');\\n            try {\\n                const response = await fetch(endpoint);\\n                if (!response.ok) {\\n                    throw new Error(\'HTTP \' + response.status);\\n                }\\n                const data = await response.json();\\n                let assetsList = [];\\n                \\n                // API tr·∫£ v·ªÅ format: { themes: [], fonts: [], sounds: [], images: [] }\\n                const ts=[\'themes\',\'fonts\',\'sounds\',\'images\'],tm={\'themes\':\'theme\',\'fonts\':\'font\',\'sounds\':\'sound\',\'images\':\'image\'};\\n                for(let i=0;i<ts.length;i++){const t=ts[i];if(data[t]&&Array.isArray(data[t])){for(let j=0;j<data[t].length;j++){const a=data[t][j];a.type=tm[t];assetsList.push(a);}}}\\n                if(assetsList.length===0){\\n                    if(Array.isArray(data))assetsList=data;\\n                    else if(data.vip_required){setPortalAssetsStatus(\'Thi·∫øt b·ªã ch∆∞a ƒë∆∞·ª£c k√≠ch ho·∫°t VIP. Vui l√≤ng ƒëƒÉng k√Ω tr√™n portal.\',true);portalAssetsListEl.innerHTML=\'\';return;}\\n                    else if(Array.isArray(data.assets))assetsList=data.assets;\\n                    else if(Array.isArray(data.list))assetsList=data.list;\\n                    else if(data.data&&Array.isArray(data.data))assetsList=data.data;\\n                }\\n                \\n                if (!assetsList.length) {\\n                    setPortalAssetsStatus(\'Kh√¥ng t√¨m th·∫•y assets VIP n√†o cho thi·∫øt b·ªã n√†y. Ki·ªÉm tra l·∫°i API ho·∫∑c tr·∫°ng th√°i VIP.\', true);\\n                    portalAssetsListEl.innerHTML = \'\';\\n                    return;\\n                }\\n                portalAssetsList = assetsList;\\n                renderPortalAssetsList(assetsList);\\n                setPortalAssetsStatus(\'Ch·ªçn m·ªôt assets VIP b√™n d∆∞·ªõi ƒë·ªÉ n√¢ng c·∫•p.\');\\n            } catch (error) {\\n                console.error(\'Portal assets fetch error\', error);\\n                setPortalAssetsStatus(\'Kh√¥ng th·ªÉ k·∫øt n·ªëi portal. Ki·ªÉm tra m·∫°ng ho·∫∑c tr·∫°ng th√°i VIP. Error: \' + error.message, true);\\n                portalAssetsListEl.innerHTML = \'\';\\n            }\\n        }\\n\\n        async function tryFetchPortalAssetsList(force = false) {\\n            if (!ensureAssetsPortalElements()) return;\\n            if (!portalConfig || !deviceMacAddress) return;\\n            if (portalAssetsFetchRequested && !force) return;\\n            portalAssetsFetchRequested = true;\\n            await loadPortalAssetsList();\\n        }\\n\\n        function initPortalAssetsSection() {\\n            if (!ensureAssetsPortalElements()) {\\n                return;\\n            }\\n            if (portalConfig && deviceMacAddress) {\\n                tryFetchPortalAssetsList();\\n            } else {\\n                fetchPortalConfig().then(() => {\\n                    if (deviceMacAddress) {\\n                        tryFetchPortalAssetsList();\\n                    }\\n                });\\n            }\\n        }\\n\\n        // Initialize Assets Portal when device info is loaded\\n        function startAssetsPortalInit() {\\n            console.log(\'Starting assets portal initialization...\');\\n            // Wait a bit longer to ensure device info is loaded\\n            setTimeout(() => {\\n                initPortalAssetsSection();\\n            }, 2000);\\n        }\\n        \\n        if (document.readyState === \'loading\') {\\n            document.addEventListener(\'DOMContentLoaded\', startAssetsPortalInit);\\n        } else {\\n            startAssetsPortalInit();\\n        }\\n        \\n        function escapeHtml(text) {\\n            const div = document.createElement(\'div\');\\n            div.textContent = text;\\n            return div.innerHTML;\\n        }\\n        \\n        async function loadSettings() {\\n            try {\\n                const res = await fetch(\'/api/settings\');\\n                const data = await res.json();\\n                if (data.music_server_url) document.getElementById(\'music_server_url\').value = data.music_server_url;\\n                if (data.alarm_music_url) document.getElementById(\'alarm_music_url\').value = data.alarm_music_url;\\n                if (data.alarm_timeout) document.getElementById(\'alarm_timeout\').value = data.alarm_timeout;\\n                if (data.sleep_mode !== undefined) document.getElementById(\'sleep_mode\').checked = data.sleep_mode;\\n                if (data.wake_word_sensitivity !== undefined) {\\n                    document.getElementById(\'wake_word_sensitivity\').value = data.wake_word_sensitivity;\\n                    updateWakeWordSensitivity();\\n                }\\n                if (data.wake_word_during_music !== undefined) {\\n                    document.getElementById(\'wake_word_during_music\').checked = data.wake_word_during_music;\\n                }\\n                if (data.vad_mode !== undefined) {\\n                    document.getElementById(\'vad_mode\').value = data.vad_mode;\\n                }\\n                if (data.vad_min_noise_ms !== undefined) {\\n                    document.getElementById(\'vad_min_noise_ms\').value = data.vad_min_noise_ms;\\n                    updateVadMinNoiseMs();\\n                }\\n                if (data.noise_suppression_enabled !== undefined) {\\n                    document.getElementById(\'noise_suppression_enabled\').checked = data.noise_suppression_enabled;\\n                }\\n                if (data.qr_duration !== undefined) {\\n                    document.getElementById(\'qr_duration\').value = data.qr_duration;\\n                }\\n            } catch (e) {\\n                console.error(\'Failed to load settings:\', e);\\n            }\\n        }\\n        \\n        async function loadAlarms() {\\n            try {\\n                const res = await fetch(\'/api/alarms\');\\n                const data = await res.json();\\n                const list = document.getElementById(\'alarms-list\');\\n                list.innerHTML = \'\';\\n                data.alarms.forEach(alarm => {\\n                    const div = document.createElement(\'div\');\\n                    div.className = \'alarm-item\';\\n                    div.innerHTML = \'<strong>\' + alarm.time + \'</strong> - \' + alarm.message +\\n                        \'<button class=\"delete-btn\" onclick=\"deleteAlarm(\\\'\' + alarm.id + \'\\\')\">Delete</button>\';\\n                    list.appendChild(div);\\n                });\\n            } catch (e) {\\n                console.error(\'Failed to load alarms:\', e);\\n            }\\n        }\\n        \\n        async function saveSettings() {\\n            try {\\n                const res = await fetch(\'/api/settings\', {\\n                    method: \'POST\',\\n                    headers: {\'Content-Type\': \'application/json\'},\\n                    body: JSON.stringify({\\n                        music_server_url: document.getElementById(\'music_server_url\').value,\\n                        sleep_mode: document.getElementById(\'sleep_mode\').checked,\\n                        wake_word_sensitivity: parseFloat(document.getElementById(\'wake_word_sensitivity\').value),\\n                        wake_word_during_music: document.getElementById(\'wake_word_during_music\').checked,\\n                        vad_mode: parseInt(document.getElementById(\'vad_mode\').value),\\n                        vad_min_noise_ms: parseInt(document.getElementById(\'vad_min_noise_ms\').value),\\n                        noise_suppression_enabled: document.getElementById(\'noise_suppression_enabled\').checked\\n                    })\\n                });\\n                const data = await res.json();\\n                if (data.success) {\\n                    showStatus(\'Settings saved!\', false);\\n                } else {\\n                    showStatus(\'Failed to save: \' + data.message, true);\\n                }\\n            } catch (e) {\\n                showStatus(\'Error: \' + e.message, true);\\n            }\\n        }\\n        \\n        async function saveAlarmMusic() {\\n            try {\\n                const url = document.getElementById(\'alarm_music_url\').value;\\n                const timeout = parseInt(document.getElementById(\'alarm_timeout\').value) || 120;\\n                const res = await fetch(\'/api/settings\', {\\n                    method: \'POST\',\\n                    headers: {\'Content-Type\': \'application/json\'},\\n                    body: JSON.stringify({\\n                        alarm_music_url: url,\\n                        alarm_timeout: timeout\\n                    })\\n                });\\n                const data = await res.json();\\n                if (data.success) {\\n                    showStatus(\'Alarm music settings saved!\', false);\\n                } else {\\n                    showStatus(\'Failed to save: \' + data.message, true);\\n                }\\n            } catch (e) {\\n                showStatus(\'Error: \' + e.message, true);\\n            }\\n        }\\n        \\n        async function addAlarm() {\\n            try {\\n                const time = document.getElementById(\'new_alarm_time\').value;\\n                const daysStr = document.getElementById(\'new_alarm_days\').value;\\n                const message = document.getElementById(\'new_alarm_message\').value;\\n                const days = daysStr.split(\',\').map(d => parseInt(d.trim())).filter(d => !isNaN(d));\\n                \\n                const res = await fetch(\'/api/alarms\', {\\n                    method: \'POST\',\\n                    headers: {\'Content-Type\': \'application/json\'},\\n                    body: JSON.stringify({ time, days, message })\\n                });\\n                const data = await res.json();\\n                if (data.success) {\\n                    showStatus(\'Alarm added!\', false);\\n                    hideAddAlarm();\\n                    loadAlarms();\\n                } else {\\n                    showStatus(\'Failed: \' + data.message, true);\\n                }\\n            } catch (e) {\\n                showStatus(\'Error: \' + e.message, true);\\n            }\\n        }\\n        \\n        async function deleteAlarm(id) {\\n            try {\\n                const res = await fetch(\'/api/alarms/\' + id, { method: \'DELETE\' });\\n                const data = await res.json();\\n                if (data.success) {\\n                    showStatus(\'Alarm deleted!\', false);\\n                    loadAlarms();\\n                } else {\\n                    showStatus(\'Failed: \' + data.message, true);\\n                }\\n            } catch (e) {\\n                showStatus(\'Error: \' + e.message, true);\\n            }\\n        }\\n        \\n        function showAddRadioChannel() {\\n            document.getElementById(\'add-radio-form\').style.display = \'block\';\\n        }\\n        \\n        function hideAddRadioChannel() {\\n            document.getElementById(\'add-radio-form\').style.display = \'none\';\\n            document.getElementById(\'new_radio_title\').value = \'\';\\n            document.getElementById(\'new_radio_url\').value = \'\';\\n            document.getElementById(\'new_radio_artist\').value = \'\';\\n        }\\n        \\n        async function loadRadioChannels() {\\n            try {\\n                const res = await fetch(\'/api/radio/channels\');\\n                const data = await res.json();\\n                const list = document.getElementById(\'radio-channels-list\');\\n                list.innerHTML = \'\';\\n                data.forEach((channel, idx) => {\\n                    const div = document.createElement(\'div\');\\n                    div.className = \'alarm-item\';\\n                    div.innerHTML = \'<strong>\' + (idx + 1) + \'. \' + channel.title + \'</strong><br>\' +\\n                        \'URL: \' + channel.url + (channel.artist ? \'<br>Artist: \' + channel.artist : \'\') +\\n                        \'<button class=\"delete-btn\" onclick=\"deleteRadioChannel(\' + idx + \')\">Delete</button>\';\\n                    list.appendChild(div);\\n                });\\n            } catch (e) {\\n                console.error(\'Failed to load radio channels:\', e);\\n            }\\n        }\\n        \\n        async function addRadioChannel() {\\n            const title = document.getElementById(\'new_radio_title\').value.trim();\\n            const url = document.getElementById(\'new_radio_url\').value.trim();\\n            const artist = document.getElementById(\'new_radio_artist\').value.trim();\\n            \\n            if (!title || !url) {\\n                showStatus(\'Title and URL are required\', true);\\n                return;\\n            }\\n            \\n            try {\\n                const res = await fetch(\'/api/radio/channels\');\\n                const channels = await res.json();\\n                channels.push({\\n                    title: title,\\n                    url: url,\\n                    artist: artist || \'\',\\n                    duration: \'N/A\'\\n                });\\n                \\n                const saveRes = await fetch(\'/api/radio/channels\', {\\n                    method: \'PUT\',\\n                    headers: {\'Content-Type\': \'application/json\'},\\n                    body: JSON.stringify(channels)\\n                });\\n                const data = await saveRes.json();\\n                if (data.success) {\\n                    showStatus(\'Radio channel added!\', false);\\n                    hideAddRadioChannel();\\n                    loadRadioChannels();\\n                } else {\\n                    showStatus(\'Failed: \' + data.message, true);\\n                }\\n            } catch (e) {\\n                showStatus(\'Error: \' + e.message, true);\\n            }\\n        }\\n        \\n        async function deleteRadioChannel(idx) {\\n            try {\\n                const res = await fetch(\'/api/radio/channels\');\\n                const channels = await res.json();\\n                channels.splice(idx, 1);\\n                \\n                const saveRes = await fetch(\'/api/radio/channels\', {\\n                    method: \'PUT\',\\n                    headers: {\'Content-Type\': \'application/json\'},\\n                    body: JSON.stringify(channels)\\n                });\\n                const data = await saveRes.json();\\n                if (data.success) {\\n                    showStatus(\'Radio channel deleted!\', false);\\n                    loadRadioChannels();\\n                } else {\\n                    showStatus(\'Failed: \' + data.message, true);\\n                }\\n            } catch (e) {\\n                showStatus(\'Error: \' + e.message, true);\\n            }\\n        }\\n        \\n        async function saveRadioChannels() {\\n            try {\\n                const res = await fetch(\'/api/radio/channels\');\\n                const channels = await res.json();\\n                \\n                const saveRes = await fetch(\'/api/radio/channels\', {\\n                    method: \'PUT\',\\n                    headers: {\'Content-Type\': \'application/json\'},\\n                    body: JSON.stringify(channels)\\n                });\\n                const data = await saveRes.json();\\n                if (data.success) {\\n                    showStatus(\'Radio channels saved!\', false);\\n                    loadRadioChannels();\\n                } else {\\n                    showStatus(\'Failed: \' + data.message, true);\\n                }\\n            } catch (e) {\\n                showStatus(\'Error: \' + e.message, true);\\n            }\\n        }\\n        \\n        // Chat messages array\\n        let chatMessages = [];\\n        \\n        function renderChatMessage(entry) {\\n            const text = entry.text || \'\';\\n            const sender = entry.sender || \'user\';\\n            const timeStr = entry.timestamp || new Date().toLocaleTimeString(\'vi-VN\', {hour: \'2-digit\', minute: \'2-digit\'});\\n            const messagesContainer = document.getElementById(\'chat-messages\');\\n            const emptyMessage = messagesContainer.querySelector(\'div[style*=\"text-align: center\"]\');\\n            if (emptyMessage) {\\n                emptyMessage.remove();\\n            }\\n            \\n            const messageDiv = document.createElement(\'div\');\\n            messageDiv.className = \'chat-message\';\\n            messageDiv.style.cssText = `\\n                display: flex;\\n                margin-bottom: 15px;\\n                animation: slideIn 0.3s ease-out;\\n                ${sender === \'user\' ? \'justify-content: flex-end;\' : \'justify-content: flex-start;\'}\\n            `;\\n            \\n            const messageBubble = document.createElement(\'div\');\\n            messageBubble.style.cssText = `\\n                max-width: 70%;\\n                padding: 12px 16px;\\n                border-radius: 18px;\\n                word-wrap: break-word;\\n                box-shadow: 0 2px 4px rgba(0,0,0,0.1);\\n                ${sender === \'user\' \\n                    ? \'background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-bottom-right-radius: 4px;\' \\n                    : \'background: #f0f0f0; color: #333; border-bottom-left-radius: 4px;\'}\\n            `;\\n            \\n            const messageText = document.createElement(\'div\');\\n            messageText.style.cssText = \'font-size: 14px; line-height: 1.5; white-space: pre-wrap;\';\\n            messageText.textContent = text;\\n            messageBubble.appendChild(messageText);\\n            \\n            const timeSpan = document.createElement(\'div\');\\n            timeSpan.style.cssText = `\\n                font-size: 11px;\\n                margin-top: 4px;\\n                opacity: 0.7;\\n                ${sender === \'user\' ? \'color: rgba(255,255,255,0.8);\' : \'color: #666;\'}\\n            `;\\n            timeSpan.textContent = timeStr;\\n            messageBubble.appendChild(timeSpan);\\n            \\n            messageDiv.appendChild(messageBubble);\\n            messagesContainer.appendChild(messageDiv);\\n            \\n            messagesContainer.scrollTop = messagesContainer.scrollHeight;\\n        }\\n        \\n        function addChatMessage(text, sender, timestamp = null) {\\n            const timeStr = timestamp instanceof Date ? timestamp.toLocaleTimeString(\'vi-VN\', {hour: \'2-digit\', minute: \'2-digit\'}) : (timestamp || new Date().toLocaleTimeString(\'vi-VN\', {hour: \'2-digit\', minute: \'2-digit\'}));\\n            const entry = {text, sender, timestamp: timeStr};\\n            chatMessages.push(entry);\\n            saveChatHistory();\\n            renderChatMessage(entry);\\n        }\\n        \\n        // Show typing indicator\\n        function showTypingIndicator() {\\n            const indicator = document.getElementById(\'typing-indicator\');\\n            indicator.style.display = \'block\';\\n            \\n            let dots = 0;\\n            const dotsInterval = setInterval(() => {\\n                dots = (dots + 1) % 4;\\n                document.getElementById(\'typing-dots\').textContent = \'.\'.repeat(dots);\\n            }, 500);\\n            \\n            indicator.dataset.interval = dotsInterval;\\n        }\\n        \\n        // Hide typing indicator\\n        function hideTypingIndicator() {\\n            const indicator = document.getElementById(\'typing-indicator\');\\n            indicator.style.display = \'none\';\\n            if (indicator.dataset.interval) {\\n                clearInterval(parseInt(indicator.dataset.interval));\\n            }\\n        }\\n        \\n        // Save chat history to localStorage\\n        function saveChatHistory() {\\n            try {\\n                localStorage.setItem(\'xiaozhi_chat_history\', JSON.stringify(chatMessages));\\n            } catch (e) {\\n                console.warn(\'Failed to save chat history:\', e);\\n            }\\n        }\\n        \\n        // Load chat history from localStorage\\n        function loadChatHistory() {\\n            try {\\n                const saved = localStorage.getItem(\'xiaozhi_chat_history\');\\n                if (saved) {\\n                    chatMessages = JSON.parse(saved);\\n                    const messagesContainer = document.getElementById(\'chat-messages\');\\n                    messagesContainer.innerHTML = \'\';\\n                    chatMessages.forEach(msg => renderChatMessage(msg));\\n                }\\n            } catch (e) {\\n                console.warn(\'Failed to load chat history:\', e);\\n            }\\n        }\\n        \\n        // Clear chat\\n        function clearChat() {\\n            if (confirm(\'B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a to√†n b·ªô l·ªãch s·ª≠ chat?\')) {\\n                chatMessages = [];\\n                const messagesContainer = document.getElementById(\'chat-messages\');\\n                messagesContainer.innerHTML = \'<div style=\"text-align: center; color: #999; padding: 20px; font-size: 14px;\">üí¨ B·∫Øt ƒë·∫ßu cu·ªôc tr√≤ chuy·ªán v·ªõi AI...</div>\';\\n                saveChatHistory();\\n            }\\n        }\\n        \\n        async function sendTextToAI() {\\n            const textInput = document.getElementById(\'ai_text_input\');\\n            const text = textInput.value.trim();\\n            if (!text) {\\n                showStatus(\'Vui l√≤ng nh·∫≠p tin nh·∫Øn\', true);\\n                return;\\n            }\\n            \\n            // Disable input and button\\n            textInput.disabled = true;\\n            const sendButton = document.getElementById(\'send-button\');\\n            sendButton.disabled = true;\\n            sendButton.textContent = \'‚è≥ ƒêang g·ª≠i...\';\\n            \\n            // Add user message to chat\\n            addChatMessage(text, \'user\');\\n            \\n            // Clear input\\n            textInput.value = \'\';\\n            textInput.style.height = \'auto\';\\n            \\n            // Show typing indicator\\n            showTypingIndicator();\\n            \\n            try {\\n                const res = await fetch(\'/api/ai/send\', {\\n                    method: \'POST\',\\n                    headers: {\'Content-Type\': \'application/json\'},\\n                    body: JSON.stringify({ text: text })\\n                });\\n                const data = await res.json();\\n                \\n                // Hide typing indicator\\n                hideTypingIndicator();\\n                \\n                if (data.success) {\\n                    // Add AI response placeholder (actual response will come from device)\\n                    addChatMessage(\'‚úÖ Tin nh·∫Øn ƒë√£ ƒë∆∞·ª£c g·ª≠i ƒë·∫øn AI. Ph·∫£n h·ªìi s·∫Ω hi·ªÉn th·ªã tr√™n thi·∫øt b·ªã.\', \'ai\');\\n                    showStatus(\'Tin nh·∫Øn ƒë√£ g·ª≠i th√†nh c√¥ng!\', false);\\n                } else {\\n                    addChatMessage(\'‚ùå L·ªói: \' + (data.message || \'Kh√¥ng th·ªÉ g·ª≠i tin nh·∫Øn\'), \'ai\');\\n                    showStatus(\'L·ªói: \' + (data.message || \'Kh√¥ng th·ªÉ g·ª≠i tin nh·∫Øn\'), true);\\n                }\\n            } catch (e) {\\n                hideTypingIndicator();\\n                addChatMessage(\'‚ùå L·ªói k·∫øt n·ªëi: \' + e.message, \'ai\');\\n                showStatus(\'L·ªói: \' + e.message, true);\\n            } finally {\\n                // Re-enable input and button\\n                textInput.disabled = false;\\n                sendButton.disabled = false;\\n                sendButton.textContent = \'üì§ G·ª≠i\';\\n                textInput.focus();\\n            }\\n        }\\n        \\n        \\n        // Load on page load\\n        loadSettings();\\n        loadAlarms();\\n        loadRadioChannels();\\n        loadQrSettings();\\n        checkVipStatus();\\n        \\n        // Add Enter key support for Send Text to AI textarea\\n        const textInput = document.getElementById(\'ai_text_input\');\\n        textInput.addEventListener(\'keydown\', function(e) {\\n            if (e.key === \'Enter\' && !e.shiftKey) {\\n                e.preventDefault(); // Prevent newline\\n                sendTextToAI();\\n            }\\n        });\\n        \\n        // Auto-resize textarea\\n        textInput.addEventListener(\'input\', function() {\\n            this.style.height = \'auto\';\\n            this.style.height = Math.min(this.scrollHeight, 120) + \'px\';\\n        });\\n        \\n        // Load chat history on page load\\n        loadChatHistory();\\n        \\n        async function upgradeFirmware() {\\n            const url = document.getElementById(\'ota_firmware_url\').value.trim();\\n            if (!url) {\\n                showStatus(\'Please enter firmware URL\', true);\\n                return;\\n            }\\n            \\n            if (!confirm(\'‚ö†Ô∏è C·∫£nh b√°o: N√¢ng c·∫•p firmware s·∫Ω kh·ªüi ƒë·ªông l·∫°i thi·∫øt b·ªã. B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ti·∫øp t·ª•c?\')) {\\n                return;\\n            }\\n            \\n            const statusDiv = document.getElementById(\'ota-status\');\\n            statusDiv.style.display = \'block\';\\n            statusDiv.textContent = \'ƒêang b·∫Øt ƒë·∫ßu n√¢ng c·∫•p firmware...\';\\n            statusDiv.style.background = \'#fff3cd\';\\n            statusDiv.style.color = \'#856404\';\\n            \\n            try {\\n                const res = await fetch(\'/api/ota/upgrade\', {\\n                    method: \'POST\',\\n                    headers: {\'Content-Type\': \'application/json\'},\\n                    body: JSON.stringify({ url: url })\\n                });\\n                const data = await res.json();\\n                if (data.success) {\\n                    statusDiv.textContent = \'‚úÖ N√¢ng c·∫•p firmware ƒë√£ b·∫Øt ƒë·∫ßu! Thi·∫øt b·ªã s·∫Ω kh·ªüi ƒë·ªông l·∫°i sau khi ho√†n t·∫•t.\';\\n                    statusDiv.style.background = \'#d4edda\';\\n                    statusDiv.style.color = \'#155724\';\\n                    showStatus(\'Firmware upgrade started!\', false);\\n                } else {\\n                    statusDiv.textContent = \'‚ùå L·ªói: \' + (data.message || \'Unknown error\');\\n                    statusDiv.style.background = \'#f8d7da\';\\n                    statusDiv.style.color = \'#721c24\';\\n                    showStatus(\'Failed: \' + (data.message || \'Unknown error\'), true);\\n                }\\n            } catch (e) {\\n                statusDiv.textContent = \'‚ùå L·ªói k·∫øt n·ªëi: \' + e.message;\\n                statusDiv.style.background = \'#f8d7da\';\\n                statusDiv.style.color = \'#721c24\';\\n                showStatus(\'Error: \' + e.message, true);\\n            }\\n        }\\n        \\n        async function upgradeAssets() {\\n            const url = document.getElementById(\'assets_url\').value.trim();\\n            if (!url) {\\n                showStatus(\'Please enter assets URL\', true);\\n                return;\\n            }\\n            \\n            if (!confirm(\'‚ö†Ô∏è L∆∞u √Ω: Upgrade assets s·∫Ω t·∫£i v√† flash file assets m·ªõi. B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ti·∫øp t·ª•c?\')) {\\n                return;\\n            }\\n            \\n            const statusDiv = document.getElementById(\'assets-status\');\\n            statusDiv.style.display = \'block\';\\n            statusDiv.textContent = \'ƒêang b·∫Øt ƒë·∫ßu t·∫£i assets...\';\\n            statusDiv.style.background = \'#fff3cd\';\\n            statusDiv.style.color = \'#856404\';\\n            \\n            try {\\n                const res = await fetch(\'/api/assets/upgrade\', {\\n                    method: \'POST\',\\n                    headers: {\'Content-Type\': \'application/json\'},\\n                    body: JSON.stringify({ url: url })\\n                });\\n                const data = await res.json();\\n                if (data.success) {\\n                    statusDiv.textContent = \'‚úÖ Upgrade assets ƒë√£ b·∫Øt ƒë·∫ßu! Vui l√≤ng ƒë·ª£i qu√° tr√¨nh download v√† flash ho√†n t·∫•t.\';\\n                    statusDiv.style.background = \'#d4edda\';\\n                    statusDiv.style.color = \'#155724\';\\n                    showStatus(\'Assets upgrade started!\', false);\\n                } else {\\n                    statusDiv.textContent = \'‚ùå L·ªói: \' + (data.message || \'Unknown error\');\\n                    statusDiv.style.background = \'#f8d7da\';\\n                    statusDiv.style.color = \'#721c24\';\\n                    showStatus(\'Failed: \' + (data.message || \'Unknown error\'), true);\\n                }\\n            } catch (e) {\\n                statusDiv.textContent = \'‚ùå L·ªói k·∫øt n·ªëi: \' + e.message;\\n                statusDiv.style.background = \'#f8d7da\';\\n                statusDiv.style.color = \'#721c24\';\\n                showStatus(\'Error: \' + e.message, true);\\n            }\\n        }\\n        \\n        function updateWakeWordSensitivity() {\\n            const slider = document.getElementById(\'wake_word_sensitivity\');\\n            if (!slider) return;\\n            const value = parseFloat(slider.value);\\n            const db = (20 * Math.log10(value)).toFixed(1);\\n            const valueSpan = document.getElementById(\'wake_word_sensitivity_value\');\\n            const dbSpan = document.getElementById(\'wake_word_sensitivity_db\');\\n            if (valueSpan) valueSpan.textContent = value.toFixed(1);\\n            if (dbSpan) dbSpan.textContent = \'~\' + db;\\n        }\\n        \\n        function updateVadMinNoiseMs() {\\n            const slider = document.getElementById(\'vad_min_noise_ms\');\\n            if (!slider) return;\\n            const value = parseInt(slider.value);\\n            const valueSpan = document.getElementById(\'vad_min_noise_ms_value\');\\n            if (valueSpan) valueSpan.textContent = value;\\n        }\\n        \\n        // Load device information (MAC address, IP, etc.)\\n        async function loadDeviceInfo() {\\n            try {\\n                const response = await fetch(\'/api/device/info\');\\n                if (!response.ok) {\\n                    throw new Error(\'Failed to fetch device info\');\\n                }\\n                const data = await response.json();\\n                \\n                // Display MAC address\\n                const macElement = document.getElementById(\'mac-address\');\\n                if (macElement && data.device_id) {\\n                    // Convert device_id (format: AA-BB-CC-DD-EE-FF) back to MAC format (AA:BB:CC:DD:EE:FF)\\n                    const macAddress = data.device_id.replace(/-/g, \':\');\\n                    macElement.textContent = macAddress;\\n                    deviceMacAddress = macAddress;\\n                    tryFetchPortalMusicServers();\\n                    tryFetchPortalRadioChannels();\\n                    if(portalConfig&&!portalConfig.vip_checked)checkVipFromPortal();\\n                }\\n                \\n                // Display IP address\\n                const ipElement = document.getElementById(\'ip-address\');\\n                if (ipElement && data.ip_address) {\\n                    ipElement.textContent = data.ip_address + (data.port ? \':\' + data.port : \'\');\\n                } else if (ipElement) {\\n                    ipElement.textContent = \'Kh√¥ng c√≥\';\\n                }\\n                \\n                // Display Device ID\\n                const deviceIdElement = document.getElementById(\'device-id\');\\n                if (deviceIdElement && data.device_id) {\\n                    deviceIdElement.textContent = data.device_id;\\n                }\\n            } catch (error) {\\n                console.error(\'Error loading device info:\', error);\\n                deviceMacAddress = null;\\n                const macElement = document.getElementById(\'mac-address\');\\n                if (macElement) {\\n                    macElement.textContent = \'L·ªói khi t·∫£i th√¥ng tin\';\\n                    macElement.style.color = \'#f44336\';\\n                }\\n            }\\n        }\\n        \\n        // Copy MAC address to clipboard\\n        function copyMacAddress(event) {\\n            const macElement = document.getElementById(\'mac-address\');\\n            if (!macElement) return;\\n            \\n            const macAddress = macElement.textContent.trim();\\n            if (macAddress === \'ƒêang t·∫£i...\' || macAddress === \'L·ªói khi t·∫£i th√¥ng tin\') {\\n                alert(\'MAC address ch∆∞a s·∫µn s√†ng\');\\n                return;\\n            }\\n            \\n            // Get button element\\n            const button = event ? event.target : document.querySelector(\'button[onclick=\"copyMacAddress()\"]\');\\n            \\n            // Copy to clipboard\\n            if (navigator.clipboard && navigator.clipboard.writeText) {\\n                navigator.clipboard.writeText(macAddress).then(function() {\\n                    // Show feedback\\n                    if (button) {\\n                        const originalText = button.textContent;\\n                        button.textContent = \'‚úÖ ƒê√£ copy!\';\\n                        button.style.background = \'#4caf50\';\\n                        setTimeout(function() {\\n                            button.textContent = originalText;\\n                            button.style.background = \'#667eea\';\\n                        }, 2000);\\n                    }\\n                }).catch(function(err) {\\n                    console.error(\'Failed to copy:\', err);\\n                    alert(\'Kh√¥ng th·ªÉ copy. Vui l√≤ng copy th·ªß c√¥ng: \' + macAddress);\\n                });\\n            } else {\\n                // Fallback for older browsers\\n                const textArea = document.createElement(\'textarea\');\\n                textArea.value = macAddress;\\n                textArea.style.position = \'fixed\';\\n                textArea.style.opacity = \'0\';\\n                document.body.appendChild(textArea);\\n                textArea.select();\\n                try {\\n                    document.execCommand(\'copy\');\\n                    if (button) {\\n                        const originalText = button.textContent;\\n                        button.textContent = \'‚úÖ ƒê√£ copy!\';\\n                        button.style.background = \'#4caf50\';\\n                        setTimeout(function() {\\n                            button.textContent = originalText;\\n                            button.style.background = \'#667eea\';\\n                        }, 2000);\\n                    }\\n                } catch (err) {\\n                    alert(\'Kh√¥ng th·ªÉ copy. Vui l√≤ng copy th·ªß c√¥ng: \' + macAddress);\\n                }\\n                document.body.removeChild(textArea);\\n            }\\n        }\\n        \\n        // Load device info when page loads\\n        if (document.readyState === \'loading\') {\\n            document.addEventListener(\'DOMContentLoaded\', loadDeviceInfo);\\n        } else {\\n            loadDeviceInfo();\\n        }\\n        \\n        // Register Service Worker for PWA\\n        if (\'serviceWorker\' in navigator) {\\n            window.addEventListener(\'load\', function() {\\n                navigator.serviceWorker.register(\'/service-worker.js\')\\n                    .then(function(registration) {\\n                        console.log(\'ServiceWorker registration successful with scope: \', registration.scope);\\n                    })\\n                    .catch(function(err) {\\n                        console.log(\'ServiceWorker registration failed: \', err);\\n                    });\\n            });\\n        }\\n        \\n        // PWA Install Banner Logic - Auto Install\\n        let deferredPrompt = null;\\n        let pwaBanner = null;\\n        let pwaInstallBtn = null;\\n        \\n        // Initialize PWA elements when DOM is ready\\n        function initPWA() {\\n            pwaBanner = document.getElementById(\'pwa-install-banner\');\\n            pwaInstallBtn = document.getElementById(\'pwa-install-btn\');\\n            \\n            if (!pwaBanner) {\\n                console.warn(\'PWA banner element not found\');\\n                return;\\n            }\\n            \\n            console.log(\'PWA banner initialized\');\\n            \\n            // Check if already installed\\n            if (isPWAInstalled()) {\\n                console.log(\'PWA already installed, hiding banner\');\\n                pwaBanner.style.display = \'none\';\\n                return;\\n            }\\n            \\n            // Check if on GitHub Pages App page (kh√¥ng hi·ªÉn th·ªã banner ·ªü ƒë√≥)\\n            if (isOnAppPage()) {\\n                console.log(\'On GitHub Pages App page, hiding banner\');\\n                pwaBanner.style.display = \'none\';\\n                return;\\n            }\\n            \\n            // Check if banner was dismissed\\n            if (wasBannerDismissed()) {\\n                console.log(\'PWA banner was dismissed, hiding\');\\n                pwaBanner.style.display = \'none\';\\n                return;\\n            }\\n            \\n            // Show banner after 1 second (reduced from 3 for better UX)\\n            setTimeout(function() {\\n                if (pwaBanner && !isPWAInstalled() && !wasBannerDismissed() && !isOnAppPage()) {\\n                    console.log(\'Showing PWA install banner\');\\n                    pwaBanner.style.display = \'block\';\\n                }\\n            }, 1000);\\n        }\\n        \\n        // Check if already installed\\n        function isPWAInstalled() {\\n            // Check if running as PWA\\n            if (window.matchMedia(\'(display-mode: standalone)\').matches ||\\n                window.navigator.standalone === true ||\\n                document.referrer.includes(\'android-app://\')) {\\n                return true;\\n            }\\n            // Check if on GitHub Pages App URL (user ƒë√£ c√†i t·ª´ ƒë√≥)\\n            const currentHost = window.location.hostname;\\n            if (currentHost === \'nguenvanky.github.io\' && window.location.pathname.startsWith(\'/App/\')) {\\n                // N·∫øu ƒëang ·ªü trang App, xem nh∆∞ ƒë√£ c√†i ho·∫∑c kh√¥ng c·∫ßn hi·ªÉn th·ªã banner\\n                return true;\\n            }\\n            return false;\\n        }\\n        \\n        // Check if banner was dismissed\\n        function wasBannerDismissed() {\\n            return localStorage.getItem(\'pwa-banner-dismissed\') === \'true\';\\n        }\\n        \\n        // Check if on GitHub Pages App (kh√¥ng hi·ªÉn th·ªã banner ·ªü ƒë√≥)\\n        function isOnAppPage() {\\n            const currentHost = window.location.hostname;\\n            return currentHost === \'nguenvanky.github.io\' && window.location.pathname.startsWith(\'/App/\');\\n        }\\n        \\n        // Show PWA install banner\\n        function showPWAInstallBanner() {\\n            if (!pwaBanner) {\\n                pwaBanner = document.getElementById(\'pwa-install-banner\');\\n            }\\n            \\n            // Kh√¥ng hi·ªÉn th·ªã banner n·∫øu ƒëang ·ªü trang App\\n            if (isOnAppPage()) {\\n                console.log(\'On GitHub Pages App page, cannot show banner\');\\n                alert(\'B·∫°n ƒëang ·ªü trang c√†i ƒë·∫∑t ·ª©ng d·ª•ng. Vui l√≤ng l√†m theo h∆∞·ªõng d·∫´n tr√™n trang n√†y ƒë·ªÉ c√†i ƒë·∫∑t.\');\\n                return;\\n            }\\n            \\n            if (isPWAInstalled() || wasBannerDismissed()) {\\n                return;\\n            }\\n            \\n            if (pwaBanner) {\\n                console.log(\'Force showing PWA banner\');\\n                pwaBanner.style.display = \'block\';\\n            }\\n        }\\n        \\n        // Install PWA - Android redirect to GitHub Pages, iPhone show instructions\\n        function installPWA() {\\n            console.log(\'installPWA called\');\\n            \\n            // Hide banner v√† dismiss\\n            if (pwaBanner) {\\n                pwaBanner.style.display = \'none\';\\n            }\\n            localStorage.setItem(\'pwa-banner-dismissed\', \'true\');\\n            \\n            // Detect platform\\n            const isAndroid = /Android/.test(navigator.userAgent);\\n            const isIOS = /iPhone|iPad|iPod/.test(navigator.userAgent);\\n            \\n            if (isAndroid) {\\n                // Android: Redirect to GitHub Pages App ƒë·ªÉ c√†i ƒë·∫∑t\\n                console.log(\'Android detected - redirecting to GitHub Pages App\');\\n                window.location.href = \'https://nguenvanky.github.io/App/\';\\n            } else if (isIOS) {\\n                // iOS: Hi·ªÉn th·ªã h∆∞·ªõng d·∫´n th·ªß c√¥ng\\n                console.log(\'iOS detected - showing manual instructions\');\\n                const instructions = \\n                    \'üì± H∆∞·ªõng d·∫´n c√†i ƒë·∫∑t tr√™n iPhone/iPad:\\n\\n\' +\\n                    \'1. Nh·∫•n n√∫t Share (m≈©i t√™n l√™n ‚¨ÜÔ∏è) ·ªü thanh ƒë·ªãa ch·ªâ\\n\' +\\n                    \'2. Cu·ªôn xu·ªëng v√† ch·ªçn \"Th√™m v√†o M√†n h√¨nh ch√≠nh\" ho·∫∑c \"Add to Home Screen\"\\n\' +\\n                    \'3. Nh·∫•n \"Th√™m\" ho·∫∑c \"Add\" ·ªü g√≥c ph·∫£i tr√™n\\n\' +\\n                    \'4. ·ª®ng d·ª•ng s·∫Ω xu·∫•t hi·ªán tr√™n m√†n h√¨nh ch√≠nh c·ªßa b·∫°n\\n\\n\' +\\n                    \'üí° M·∫πo: B·∫°n c≈©ng c√≥ th·ªÉ truy c·∫≠p https://nguenvanky.github.io/App/ v√† l√†m theo h∆∞·ªõng d·∫´n t∆∞∆°ng t·ª±.\';\\n                alert(instructions);\\n            } else {\\n                // Desktop ho·∫∑c browser kh√°c: Redirect ƒë·∫øn GitHub Pages App\\n                console.log(\'Desktop/Other browser detected - redirecting to GitHub Pages App\');\\n                window.location.href = \'https://nguenvanky.github.io/App/\';\\n            }\\n        }\\n        \\n        // Dismiss banner\\n        function dismissPWA() {\\n            if (pwaBanner) {\\n                pwaBanner.style.display = \'none\';\\n            }\\n            localStorage.setItem(\'pwa-banner-dismissed\', \'true\');\\n            console.log(\'PWA banner dismissed\');\\n        }\\n        \\n        // Listen for beforeinstallprompt event (Android/Chrome)\\n        window.addEventListener(\'beforeinstallprompt\', function(e) {\\n            console.log(\'beforeinstallprompt event fired - browser supports automatic install\');\\n            e.preventDefault();\\n            deferredPrompt = e;\\n            \\n            if (pwaInstallBtn) {\\n                pwaInstallBtn.textContent = \'C√†i ƒë·∫∑t ngay\';\\n            }\\n            \\n            showPWAInstallBanner();\\n        });\\n        \\n        // Listen for appinstalled event\\n        window.addEventListener(\'appinstalled\', function(evt) {\\n            console.log(\'PWA app was installed successfully by browser\');\\n            if (pwaBanner) {\\n                pwaBanner.style.display = \'none\';\\n            }\\n            localStorage.setItem(\'pwa-banner-dismissed\', \'true\');\\n            // Hide PWA install button when PWA is installed (Settings page - use specific ID)\\n            const pwaInstallButton = document.getElementById(\'pwa-install-button-fixed\') || document.querySelector(\'.pwa-install-fixed\');\\n            if (pwaInstallButton) {\\n                console.log(\'PWA installed - hiding install button\');\\n                pwaInstallButton.style.display = \'none\';\\n                pwaInstallButton.style.visibility = \'hidden\';\\n            }\\n        });\\n        \\n        // Initialize when DOM is ready\\n        if (document.readyState === \'loading\') {\\n            document.addEventListener(\'DOMContentLoaded\', initPWA);\\n        } else {\\n            // DOM already loaded\\n            initPWA();\\n        }\\n        \\n        // Hide PWA install button immediately if on GitHub Pages App page or PWA installed (Settings page)\\n        setTimeout(function() {\\n            const pwaInstallButton = document.getElementById(\'pwa-install-button-fixed\') || document.querySelector(\'.pwa-install-fixed\');\\n            if (pwaInstallButton) {\\n                const currentHost = window.location.hostname;\\n                const isOnApp = currentHost === \'nguenvanky.github.io\' && window.location.pathname.startsWith(\'/App/\');\\n                const isInstalled = window.matchMedia(\'(display-mode: standalone)\').matches ||\\n                                   window.navigator.standalone === true ||\\n                                   (document.referrer && document.referrer.includes(\'android-app://\'));\\n                if (isOnApp || isInstalled) {\\n                    console.log(\'Hiding PWA install button - on App page or PWA installed\');\\n                    pwaInstallButton.style.display = \'none\';\\n                    pwaInstallButton.style.visibility = \'hidden\';\\n                }\\n            }\\n        }, 100);\\n        \\n        // Also try to show banner even if beforeinstallprompt doesn\'t fire\\n        setTimeout(function() {\\n            if (!isPWAInstalled() && !wasBannerDismissed()) {\\n                console.log(\'Fallback: showing banner after 2 seconds\');\\n                showPWAInstallBanner();\\n            } else {\\n                console.log(\'Banner not shown - installed:\', isPWAInstalled(), \'dismissed:\', wasBannerDismissed());\\n            }\\n        }, 2000);\\n        \\n        // Debug: Log PWA status\\n        console.log(\'PWA Status - Installed:\', isPWAInstalled(), \'Dismissed:\', wasBannerDismissed());\\n        \\n        // Test function to clear dismissed state (for debugging)\\n        window.clearPWADismissed = function() {\\n            localStorage.removeItem(\'pwa-banner-dismissed\');\\n            console.log(\'PWA dismissed state cleared, reload page to see banner\');\\n        };\\n    </script>\\n    <!-- Load main JS from external -->\\n    <script src=\"https://nguenvanky.github.io/App/scripts/settings.min.js?v=1.0.0\" \\n            onerror=\"loadFallbackJS(\'settings\')\"></script>\\n</body>\\n</html>\\n";
    
    // Inject HTML into DOM
    function injectHTML() {
        try {
            // Replace current document
            document.open();
            document.write(HTML_CONTENT);
            document.close();
            
            console.log('[JS Injector] Successfully injected Settings HTML');
        } catch (error) {
            console.error('[JS Injector] Failed to inject HTML:', error);
            // Fallback: try to load from ESP32
            const ESP32_IP = window.location.hostname;
            const ESP32_PORT = window.location.port || '80';
            const ESP32_BASE = `http://${ESP32_IP}:${ESP32_PORT}`;
            
            let fallbackUrl;
            const path = window.location.pathname;
            if (path.includes('/otto') || path.includes('/control')) {
                fallbackUrl = `${ESP32_BASE}/otto-fallback`;
            } else if (path.includes('/servo') || path.includes('/servo-calibration')) {
                fallbackUrl = `${ESP32_BASE}/servo-fallback`;
            } else {
                fallbackUrl = `${ESP32_BASE}/settings-fallback`;
            }
            
            console.log('[JS Injector] Loading fallback from:', fallbackUrl);
            window.location.href = fallbackUrl;
        }
    }
    
    // Inject immediately if DOM is ready, otherwise wait
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', injectHTML);
    } else {
        injectHTML();
    }
})();
